import{d as ee,u as ae,n as le,A as b,p as g,v as te,x as S,w as r,b as c,f as a,i as t,z as n,y as i,B as k,C as j,D as C,E as P,c as v,F as T,G as F,t as y,k as O,g as se,a as re,o as u,J as U,s as m}from"./index-CJ_PivE-.js";import{_ as I}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as d}from"./InputWrapper-tSRHzcjN.js";import{S as h}from"./SpanRequired-COKghTUX.js";import{_ as oe}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as A}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as R}from"./SelectGroup.vue_vue_type_script_setup_true_lang-CwIOzTi6.js";import{_ as ie}from"./Textarea.vue_vue_type_script_setup_true_lang-Bg8QXdyw.js";import{u as ne}from"./usePostApi-Crg8MURP.js";import{u as V}from"./useGetApi-EdzHoZm6.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./index-BpkKmY4O.js";const ue={class:"text-xs text-gray-500 mt-1"},de={class:"flex items-center justify-end gap-2"},ce={key:0,class:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-1.5"},me={key:1,class:"flex iconify hugeicons--floppy-disk mr-1.5"},ke=ee({__name:"NouvelleAffectation",setup(fe){const E=re(),B=ae(),s=le({academic_personal_id:void 0,lieu_affectation:"",durree_jours:void 0,description:"",school_year_id:void 0}),{data:x,fetchData:G,loading:L}=V(b.GET_PERSONALS),{data:f,fetchData:M}=V(b.GET_FONCTIONS),{data:Y,fetchData:z,loading:q}=V(b.GET_SCHOOL_YEARS),H=o=>{var _;if(!o||!f.value)return"N/A";const e=(Array.isArray(f.value)?f.value:((_=f.value)==null?void 0:_.data)||[]).find(Z=>Z.id==o);return(e==null?void 0:e.name)||(e==null?void 0:e.title)||(e==null?void 0:e.libelle)||"N/A"},w=g(()=>{var l;return(Array.isArray(x.value)?x.value:((l=x.value)==null?void 0:l.data)||[]).map(e=>({id:e.id,name:`${e.name||e.nom||""} ${e.postnom||""} ${e.firstname||e.prenom||""}`.trim(),matricule:e.matricule,fonction_id:e.fonction_id,fonction:H(e.fonction_id)}))}),J=g(()=>{const o=Y.value;return(Array.isArray(o)?o:(o==null?void 0:o.years)??[]).map(e=>({id:e.id,label:e.name||"N/A"}))}),$=g(()=>s.academic_personal_id?w.value.find(o=>o.id===s.academic_personal_id):null),{loading:p,error:N,postData:W}=ne(),D=g(()=>s.academic_personal_id!==void 0&&s.lieu_affectation.trim()!==""&&s.lieu_affectation.length<=255&&s.durree_jours!==void 0&&s.durree_jours>=1&&s.school_year_id!==void 0);async function K(){var e;if(!D.value){m({message:"Veuillez remplir tous les champs obligatoires correctement.",type:"error"});return}const o=(e=B.user)==null?void 0:e.id;if(!o){m({message:"Impossible d'identifier l'utilisateur connecté.",type:"error"});return}const l={academic_personal_id:Number(s.academic_personal_id),lieu_affectation:s.lieu_affectation.trim(),durree_jours:Number(s.durree_jours),description:s.description.trim()||null,school_year_id:Number(s.school_year_id),author_id:Number(o)};try{if(await W(b.CREATE_PERSONNEL_AFFECTATION,l),N.value){console.error("❌ Erreur API:",N.value),m({message:N.value,type:"error"});return}m({message:"Affectation créée avec succès !",type:"success"}),Q(),setTimeout(()=>{E.push("/rh/saisie/mise-en-place-personnel")},1e3)}catch(_){console.error("Erreur lors de la soumission:",_),m({message:"Une erreur inattendue s'est produite.",type:"error"})}}function Q(){s.academic_personal_id=void 0,s.lieu_affectation="",s.durree_jours=void 0,s.description="",s.school_year_id=void 0}function X(){E.push("/rh/saisie/mise-en-place-personnel")}return te(async()=>{await Promise.all([G(),M(),z()])}),(o,l)=>(u(),S(oe,{title:"Nouvelle Affectation de Personnel","link-back":"/rh/saisie/mise-en-place-personnel","group-route":"/rh/saisie/personnel",module:"rh",breadcrumb:[{label:"Mise en place",href:"/rh/saisie/mise-en-place-personnel"},{label:"Nouvelle Affectation",isActive:!0}]},{default:r(()=>[c("form",{onSubmit:se(K,["prevent"]),class:"w-full flex flex-col space-y-8"},[a(I,{class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10",title:"Sélection du personnel"},{default:r(()=>[a(d,null,{default:r(()=>[a(t(n),{class:"text-sm"},{default:r(()=>[l[5]||(l[5]=i(" Personnel ",-1)),a(h)]),_:1}),a(t(k),{modelValue:s.academic_personal_id,"onUpdate:modelValue":l[0]||(l[0]=e=>s.academic_personal_id=e),disabled:t(L)},{default:r(()=>[a(t(j),{class:"!h-10 bg-white w-full"},{default:r(()=>[a(t(C),{placeholder:"Sélectionner un personnel"})]),_:1}),a(t(P),null,{default:r(()=>[a(t(R),null,{default:r(()=>[(u(!0),v(F,null,T(w.value,e=>(u(),S(t(U),{key:e.id,value:e.id},{default:r(()=>[i(y(e.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),a(d,null,{default:r(()=>{var e;return[a(t(n),{class:"text-sm"},{default:r(()=>[...l[6]||(l[6]=[i("Matricule",-1)])]),_:1}),a(t(A),{value:((e=$.value)==null?void 0:e.matricule)||"",class:"bg-gray-100 transition-all h-10 rounded-md",readonly:"",placeholder:"Sélectionner d'abord un personnel"},null,8,["value"])]}),_:1}),a(d,null,{default:r(()=>{var e;return[a(t(n),{class:"text-sm"},{default:r(()=>[...l[7]||(l[7]=[i("Fonction actuelle",-1)])]),_:1}),a(t(A),{value:((e=$.value)==null?void 0:e.fonction)||"",class:"bg-gray-100 transition-all h-10 rounded-md",readonly:"",placeholder:"Sélectionner d'abord un personnel"},null,8,["value"])]}),_:1})]),_:1}),l[13]||(l[13]=c("div",{class:"w-full flex h-px bg-gray-300"},null,-1)),a(I,{class:"grid sm:grid-cols-2 gap-y-6 gap-x-10",title:"Détails de l'affectation"},{default:r(()=>[a(d,null,{default:r(()=>[a(t(n),{class:"text-sm"},{default:r(()=>[l[8]||(l[8]=i(" Lieu d'affectation ",-1)),a(h)]),_:1}),a(t(A),{modelValue:s.lieu_affectation,"onUpdate:modelValue":l[1]||(l[1]=e=>s.lieu_affectation=e),class:"bg-white transition-all h-10 rounded-md",placeholder:"Ex: Campus principal, Annexe A, Bureau central...",maxlength:"255"},null,8,["modelValue"]),c("p",ue,y(s.lieu_affectation.length)+"/255 caractères",1)]),_:1}),a(d,null,{default:r(()=>[a(t(n),{class:"text-sm"},{default:r(()=>[l[9]||(l[9]=i(" Durée (en jours) ",-1)),a(h)]),_:1}),a(t(A),{modelValue:s.durree_jours,"onUpdate:modelValue":l[2]||(l[2]=e=>s.durree_jours=e),modelModifiers:{number:!0},type:"number",min:"1",class:"bg-white transition-all h-10 rounded-md",placeholder:"Nombre de jours"},null,8,["modelValue"])]),_:1}),a(d,null,{default:r(()=>[a(t(n),{class:"text-sm"},{default:r(()=>[l[10]||(l[10]=i(" Année scolaire ",-1)),a(h)]),_:1}),a(t(k),{modelValue:s.school_year_id,"onUpdate:modelValue":l[3]||(l[3]=e=>s.school_year_id=e),disabled:t(q)},{default:r(()=>[a(t(j),{class:"!h-10 bg-white w-full"},{default:r(()=>[a(t(C),{placeholder:"Sélectionner l'année scolaire"})]),_:1}),a(t(P),null,{default:r(()=>[a(t(R),null,{default:r(()=>[(u(!0),v(F,null,T(J.value,e=>(u(),S(t(U),{key:e.id,value:e.id},{default:r(()=>[i(y(e.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),a(d,{class:"sm:col-span-2"},{default:r(()=>[a(t(n),{class:"text-sm"},{default:r(()=>[...l[11]||(l[11]=[i("Description",-1)])]),_:1}),a(t(ie),{modelValue:s.description,"onUpdate:modelValue":l[4]||(l[4]=e=>s.description=e),class:"bg-white transition-all rounded-md min-h-[100px]",placeholder:"Décrivez les détails de l'affectation (optionnel)..."},null,8,["modelValue"])]),_:1})]),_:1}),c("div",de,[a(t(O),{type:"button",variant:"outline",onClick:X,disabled:t(p)},{default:r(()=>[...l[12]||(l[12]=[c("span",{class:"flex iconify hugeicons--cancel-01 mr-1.5"},null,-1),i(" Annuler ",-1)])]),_:1},8,["disabled"]),a(t(O),{type:"submit",disabled:!D.value||t(p)},{default:r(()=>[t(p)?(u(),v("span",ce)):(u(),v("span",me)),i(" "+y(t(p)?"Enregistrement...":"Enregistrer l'affectation"),1)]),_:1},8,["disabled"])])],32)]),_:1}))}});export{ke as default};
