import{d as oe,r as T,A as h,p as f,q as Y,v as ne,a1 as de,s as c,x as p,w as t,b as N,f as s,i as r,z as _,y as n,B as S,C as A,D as w,E as V,c as v,F as C,G as E,h as ue,k as H,t as b,g as me,a as fe,o as d,J as $}from"./index-CJ_PivE-.js";import{_ as ce}from"./Textarea.vue_vue_type_script_setup_true_lang-Bg8QXdyw.js";import{_ as pe}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as _e}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as ve}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as y}from"./InputWrapper-tSRHzcjN.js";import{S as g}from"./SpanRequired-COKghTUX.js";import{a as R}from"./abandonCasesService-B1DRDXT3.js";import"./FiliaireService-CYGYY8j2.js";import"./ClassroomService--2HkcG_r.js";import"./SemestreService-BP5X1NpV.js";import{u as k}from"./useGetApi-EdzHoZm6.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"relative"},ye={key:0,class:"p-2 text-gray-500 text-sm"},ge={class:"flex items-center justify-end gap-2"},ze=oe({__name:"NewAbandon",setup(he){const U=fe(),q=de(),u=T(!1),D=T(null),i=T({school_year_id:0,classroom_id:0,filiere_id:null,semester_id:1,student_id:0,comment:""}),{data:J,fetchData:P}=k(h.GET_SCHOOL_YEARS),{data:W,fetchData:K}=k(h.GET_CLASSROOMS),{data:Q,fetchData:X}=k(h.GET_FILLIERES),{data:Z,fetchData:ee}=k(h.GET_SEMESTRE),{data:ae,fetchData:le}=k(h.GET_STUDENTS),x=T(""),G=f(()=>{const a=J.value;return(Array.isArray(a)?a:(a==null?void 0:a.years)||(a==null?void 0:a.data)||[]).map(e=>({id:e.id,label:e.name}))}),L=f(()=>{const a=W.value;return(Array.isArray(a)?a:(a==null?void 0:a.data)||[]).map(e=>({id:e.id,name:e.name,filiaire_id:e.filiaire_id}))}),M=f(()=>{const a=Q.value;return(Array.isArray(a)?a:(a==null?void 0:a.data)||[]).map(e=>({id:e.id,name:e.name}))}),z=f(()=>{const a=Z.value;return(Array.isArray(a)?a:(a==null?void 0:a.data)||[]).map(e=>({id:e.id,label:e.name}))}),I=f(()=>{var e;const a=ae.value;return(Array.isArray(a)?a:((e=a==null?void 0:a.students)==null?void 0:e.data)||(a==null?void 0:a.data)||[]).map(o=>({id:o.id,full_name:`${(o==null?void 0:o.name)??""} ${(o==null?void 0:o.firstname)??""} ${(o==null?void 0:o.lastname)??""}`.trim(),classroom_id:o.classroom_id}))}),se=f(()=>i.value.filiere_id?L.value.filter(a=>String(a.filiaire_id)===String(i.value.filiere_id)):L.value),O=f(()=>{let a=I.value;return i.value.classroom_id&&(a=a.filter(l=>String(l.classroom_id)===String(i.value.classroom_id))),x.value&&(a=a.filter(l=>l.full_name.toLowerCase().includes(x.value.toLowerCase()))),a});Y(()=>i.value.filiere_id,()=>{}),Y(()=>i.value.classroom_id,()=>{}),ne(async()=>{P(),K({limit:1e3}),X(),le({limit:1e3}),ee(),q.params.id&&(u.value=!0,D.value=Number(q.params.id),await te(D.value))});async function te(a){var l,e,o,B,F,j;try{const m=await R.getAbandonCaseById(a);m!=null&&m.data&&(i.value={school_year_id:(l=m.data)==null?void 0:l.data.school_year_id,classroom_id:(e=m.data)==null?void 0:e.data.classroom_id,filiere_id:(o=m.data)==null?void 0:o.data.filiere_id,semester_id:(B=m.data)==null?void 0:B.data.semester_id,student_id:(F=m.data)==null?void 0:F.data.student_id,comment:(j=m.data)==null?void 0:j.data.comment},c({message:"Données chargées avec succès",type:"success"}))}catch{c({message:"Erreur lors du chargement des données",type:"error"})}}function re(){U.push("/apprenants/operations/gestion-disciplinaire/abandons")}async function ie(){try{u.value&&D.value?(await R.updateAbandonCase(D.value,i.value),c({message:"Abandon mis à jour avec succès",type:"success"})):(await R.createAbandonCase(i.value),c({message:"Abandon créé avec succès",type:"success"})),U.push("/apprenants/operations/gestion-disciplinaire/abandons")}catch(a){if(console.error("Form submission error:",a),a.response&&a.response.status===422){const l=a.response.data.errors;let e="Erreur de validation";l?e=Object.values(l).flat().join(`
`):a.response.data.message&&(e=a.response.data.message),c({message:e,type:"error"})}else c({message:"Erreur lors de l'enregistrement",type:"error"})}}return(a,l)=>(d(),p(_e,{"link-back":"/apprenants/operations/gestion-disciplinaire/abandons",title:u.value?"Modifier Abandon":"Nouvel Abandon","group-route":"/apprenants/operations/gestion-disciplinaire/abandons",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Gestion Disciplinaire",href:"/apprenants/operations/gestion-disciplinaire"},{label:"Liste des Abandons",href:"/apprenants/operations/gestion-disciplinaire/abandons"},{label:u.value?"Modifier Abandon":"Nouvel Abandon",href:"#"}]},{default:t(()=>[N("form",{class:"w-full flex flex-col space-y-8",onSubmit:me(ie,["prevent"])},[s(ve,{title:"",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:t(()=>[s(y,null,{default:t(()=>[s(r(_),{for:"school_year_id"},{default:t(()=>[l[7]||(l[7]=n("Année scolaire",-1)),s(g)]),_:1}),s(r(S),{modelValue:i.value.school_year_id,"onUpdate:modelValue":l[0]||(l[0]=e=>i.value.school_year_id=e),required:""},{default:t(()=>[s(r(A),{class:"!h-10 bg-white w-full"},{default:t(()=>{var e;return[s(r(w),{placeholder:u.value?(e=G.value.find(o=>o.id==i.value.school_year_id))==null?void 0:e.label:"Sélectionnez l'année"},null,8,["placeholder"])]}),_:1}),s(r(V),null,{default:t(()=>[(d(!0),v(E,null,C(G.value,e=>(d(),p(r($),{key:e.id,value:e.id},{default:t(()=>[n(b(e.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(y,null,{default:t(()=>[s(r(_),{for:"filiere"},{default:t(()=>[l[8]||(l[8]=n("Section",-1)),s(g)]),_:1}),s(r(S),{modelValue:i.value.filiere_id,"onUpdate:modelValue":l[1]||(l[1]=e=>i.value.filiere_id=e),required:""},{default:t(()=>[s(r(A),{class:"!h-10 bg-white w-full"},{default:t(()=>{var e;return[s(r(w),{placeholder:u.value?(e=M.value.find(o=>o.id==i.value.filiere_id))==null?void 0:e.name:"Sélectionnez la section"},null,8,["placeholder"])]}),_:1}),s(r(V),null,{default:t(()=>[(d(!0),v(E,null,C(M.value,e=>(d(),p(r($),{key:e.id,value:e.id},{default:t(()=>[n(b(e.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(y,null,{default:t(()=>[s(r(_),{for:"classroom"},{default:t(()=>[l[9]||(l[9]=n("Classe",-1)),s(g)]),_:1}),s(r(S),{modelValue:i.value.classroom_id,"onUpdate:modelValue":l[2]||(l[2]=e=>i.value.classroom_id=e),required:"",disabled:!i.value.filiere_id},{default:t(()=>[s(r(A),{class:"!h-10 bg-white w-full"},{default:t(()=>{var e;return[s(r(w),{placeholder:u.value?(e=L.value.find(o=>o.id==i.value.classroom_id))==null?void 0:e.name:"Sélectionnez la classe"},null,8,["placeholder"])]}),_:1}),s(r(V),null,{default:t(()=>[(d(!0),v(E,null,C(se.value,e=>(d(),p(r($),{key:e.id,value:e.id},{default:t(()=>[n(b(e.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),s(y,null,{default:t(()=>[s(r(_),{for:"semester"},{default:t(()=>[l[10]||(l[10]=n("Semestre",-1)),s(g)]),_:1}),s(r(S),{modelValue:i.value.semester_id,"onUpdate:modelValue":l[3]||(l[3]=e=>i.value.semester_id=e),required:""},{default:t(()=>[s(r(A),{class:"!h-10 bg-white w-full"},{default:t(()=>{var e;return[s(r(w),{placeholder:u.value?(e=z.value.find(o=>o.id==i.value.semester_id))==null?void 0:e.label:"Sélectionnez le semestre"},null,8,["placeholder"])]}),_:1}),s(r(V),null,{default:t(()=>[(d(!0),v(E,null,C(z.value,e=>(d(),p(r($),{key:e.id,value:e.id},{default:t(()=>[n(b(e.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),s(y,null,{default:t(()=>[s(r(_),{for:"student"},{default:t(()=>[l[11]||(l[11]=n("Élève",-1)),s(g)]),_:1}),N("div",be,[s(r(pe),{modelValue:x.value,"onUpdate:modelValue":l[4]||(l[4]=e=>x.value=e),placeholder:"Rechercher un élève...",class:"mb-2 !h-9"},null,8,["modelValue"]),s(r(S),{modelValue:i.value.student_id,"onUpdate:modelValue":l[5]||(l[5]=e=>i.value.student_id=e),required:"",disabled:!i.value.classroom_id},{default:t(()=>[s(r(A),{class:"!h-10 bg-white w-full"},{default:t(()=>{var e;return[s(r(w),{placeholder:u.value?(e=I.value.find(o=>o.id==i.value.student_id))==null?void 0:e.full_name:"Sélectionnez l'élève"},null,8,["placeholder"])]}),_:1}),s(r(V),null,{default:t(()=>[(d(!0),v(E,null,C(O.value,e=>(d(),p(r($),{key:e.id,value:e.id},{default:t(()=>[n(b(e.full_name),1)]),_:2},1032,["value"]))),128)),O.value.length===0?(d(),v("div",ye," Aucun apprenant trouvé ")):ue("",!0)]),_:1})]),_:1},8,["modelValue","disabled"])])]),_:1}),s(y,{class:"lg:col-span-3"},{default:t(()=>[s(r(_),{for:"comment"},{default:t(()=>[l[12]||(l[12]=n("Commentaire",-1)),s(g)]),_:1}),s(r(ce),{modelValue:i.value.comment,"onUpdate:modelValue":l[6]||(l[6]=e=>i.value.comment=e),placeholder:"Décrivez les raisons de l'abandon...",required:"",class:"w-full min-h-[100px]"},null,8,["modelValue"])]),_:1})]),_:1}),N("div",ge,[s(r(H),{type:"button",variant:"outline",onClick:re},{default:t(()=>[...l[13]||(l[13]=[n(" Annuler ",-1)])]),_:1}),s(r(H),{type:"submit"},{default:t(()=>[n(b(u.value?"Mettre à jour l'abandon":"Enregistrer l'abandon"),1)]),_:1})])],32)]),_:1},8,["title","breadcrumb"]))}});export{ze as default};
