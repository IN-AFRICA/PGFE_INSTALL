import{d as ue,r as E,A as S,v as oe,p as u,q as R,x as m,w as i,b as D,f as l,i as r,z as g,y as d,B as y,C as b,D as w,E as C,c,F as h,G as V,h as de,g as J,k as K,t as p,a as fe,o as f,J as A,s as B}from"./index-CJ_PivE-.js";import{_ as me}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as ce}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as pe}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as N}from"./InputWrapper-tSRHzcjN.js";import{S as I}from"./SpanRequired-COKghTUX.js";import{u as T}from"./useGetApi-EdzHoZm6.js";import{u as ve}from"./usePostApi-Crg8MURP.js";import{e as _e}from"./eventBus-CGRXT3Tn.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Se={class:"p-2"},ge={key:0,class:"p-2 text-gray-500 text-sm"},ye={class:"flex items-center justify-between gap-2"},be={class:"flex items-center gap-2"},Oe=ue({__name:"NewNote",setup(we){const W=fe(),n=E({anneeScolaire:"",filiere:"",classe:"",apprenant:"",numeroFauteCommise:"",conduiteSemestre1:"",conduiteSemestre2:""}),{data:v,fetchData:Q}=T(S.GET_SCHOOL_YEARS),{data:$,fetchData:X}=T(S.GET_FILLIERES),{data:L,fetchData:Y}=T(S.GET_CLASSROOMS),{data:U,fetchData:Z}=T(S.GET_STUDENTS),{data:F,fetchData:ee}=T(S.GET_CONDUITE);oe(async()=>{await Q(),await Promise.all([X(),Y(),Z(),ee()]);const e=ae();e&&(n.value.anneeScolaire=String(e))});function ae(){const e=v==null?void 0:v.value;let a=[];if(Array.isArray(e)?a=e:e&&Array.isArray(e.years)&&(a=e.years),!Array.isArray(a)||a.length===0)return null;const t=a.find(o=>o.active===!0||o.is_active===!0||o.current===!0||o.is_current===!0||o.status==="active");if(t&&t.id!==void 0)return t.id;const s=a.find(o=>String(o.name||"").toLowerCase().includes("en cours")||String(o.name||"").toLowerCase().includes("actuelle"));return s&&s.id!==void 0?s.id:a[0].id??null}const O=u(()=>{const e=v==null?void 0:v.value;return(Array.isArray(e)?e:(e==null?void 0:e.years)??[]).map(t=>({id:String(t.id),name:t.name}))}),q=u(()=>{var t;const e=$==null?void 0:$.value;return(Array.isArray(e)?e:((t=e==null?void 0:e.filiaires)==null?void 0:t.data)??(e==null?void 0:e.data)??[]).map(s=>({id:String(s.id),name:s.name}))}),k=u(()=>{var t;const e=L==null?void 0:L.value;return(Array.isArray(e)?e:((t=e==null?void 0:e.classrooms)==null?void 0:t.data)??(e==null?void 0:e.data)??[]).map(s=>({id:String(s.id),name:s.name,filiere_id:s.filiere_id??s.filiereId??null}))}),z=u(()=>{var t;const e=U==null?void 0:U.value;return(Array.isArray(e)?e:((t=e==null?void 0:e.students)==null?void 0:t.data)??(e==null?void 0:e.data)??[]).map(s=>({id:String(s.id),name:`${s.name??""} ${s.firstname??""}`.trim(),classroom_id:s.classroom_id??s.classroomId??null,filiere_id:s.filiere_id??s.filiereId??null}))}),_=E("");u(()=>{const e=z.value||[];if(!_.value)return e;const a=_.value.toLowerCase();return e.filter(t=>(t.name||"").toLowerCase().includes(a))});const x=u(()=>{var t;const e=F==null?void 0:F.value;return(Array.isArray(e)?e:((t=e==null?void 0:e.conduites)==null?void 0:t.data)??(e==null?void 0:e.data)??[]).map(s=>({id:String(s.id??s.value??""),name:s.name??s.label??String(s)}))}),te=u(()=>{const e=n.value.filiere;return e?k.value.filter(a=>!a.filiere_id||String(a.filiere_id)===String(e)):k.value}),le=u(()=>{const e=n.value.classe,a=n.value.filiere;let t=z.value;if(e){const s=t.filter(o=>o.classroom_id&&String(o.classroom_id)===String(e));if(s.length)return s}if(a){const s=t.filter(o=>o.filiere_id&&String(o.filiere_id)===String(a));if(s.length)return s}return t}),P=u(()=>{const e=le.value||[];if(!_.value)return e;const a=_.value.toLowerCase();return e.filter(t=>(t.name||"").toLowerCase().includes(a))});R(()=>n.value.filiere,()=>{n.value.classe="",n.value.apprenant=""}),R(()=>n.value.classe,()=>{n.value.apprenant=""});const G=E(""),M=E("");u(()=>{switch(G.value){case"year":return O.value;case"filiere":return q.value;case"classe":return k.value;default:return[]}}),R(G,()=>{M.value=""}),E(!1),u(()=>{var e;return((e=O.value.find(a=>a.id===n.value.anneeScolaire))==null?void 0:e.name)??""}),u(()=>{var e;return((e=q.value.find(a=>a.id===n.value.filiere))==null?void 0:e.name)??""}),u(()=>{var e;return((e=k.value.find(a=>a.id===n.value.classe))==null?void 0:e.name)??""}),u(()=>{var e;return((e=z.value.find(a=>a.id===n.value.apprenant))==null?void 0:e.name)??""}),u(()=>{var e;return((e=x.value.find(a=>a.id===n.value.conduiteSemestre1))==null?void 0:e.name)??""}),u(()=>{var e;return((e=x.value.find(a=>a.id===n.value.conduiteSemestre2))==null?void 0:e.name)??""});const{postData:re,loading:j,error:H}=ve(),ne=()=>{n.value={anneeScolaire:"",filiere:"",classe:"",apprenant:"",numeroFauteCommise:"",conduiteSemestre1:"",conduiteSemestre2:""},G.value="",M.value=""},ie=async()=>{if(!n.value.anneeScolaire||!n.value.classe||!n.value.apprenant){B({message:"Veuillez remplir tous les champs obligatoires",type:"error"});return}const e={school_year_id:Number(n.value.anneeScolaire),filiere_id:n.value.filiere?Number(n.value.filiere):null,classroom_id:Number(n.value.classe),student_id:Number(n.value.apprenant),fault_count:0,conduite_semester_1_id:n.value.conduiteSemestre1?Number(n.value.conduiteSemestre1):null,conduite_semester_2_id:n.value.conduiteSemestre2?Number(n.value.conduiteSemestre2):null};await re(S.CREATE_NOTE_CONDUITE,e),await new Promise(a=>setTimeout(a,100)),H.value?B({message:H.value||"Erreur lors de la création de la note",type:"error"}):(B({message:"Note de conduite créée avec succès",type:"success"})(_e).emit("noteConduiteUpdated"),ne())},se=()=>{W.push("/apprenants/operations/gestion-disciplinaire/note-conduite")};return(e,a)=>(f(),m(ce,{"link-back":"/apprenants/operations/gestion-disciplinaire/note-conduite",title:"Nouvelle Note de Conduite","group-route":"/apprenants/operations",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Gestion Disciplinaire",href:"/apprenants/operations/gestion-disciplinaire"},{label:"Notes de Conduite",href:"/apprenants/operations/gestion-disciplinaire/note-conduite"},{label:"Nouvelle Note",href:"/apprenants/operations/gestion-disciplinaire/note"}]},{default:i(()=>[D("form",{class:"w-full flex flex-col space-y-8",onSubmit:J(ie,["prevent"])},[l(pe,{title:"",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:i(()=>[l(N,null,{default:i(()=>[l(r(g),{for:"anneeScolaire"},{default:i(()=>[a[8]||(a[8]=d("Année scolaire",-1)),l(I)]),_:1}),l(r(y),{modelValue:n.value.anneeScolaire,"onUpdate:modelValue":a[0]||(a[0]=t=>n.value.anneeScolaire=t),required:""},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez l'année"})]),_:1}),l(r(C),null,{default:i(()=>[(f(!0),c(V,null,h(O.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(N,null,{default:i(()=>[l(r(g),{for:"filiere"},{default:i(()=>[a[9]||(a[9]=d("Section",-1)),l(I)]),_:1}),l(r(y),{modelValue:n.value.filiere,"onUpdate:modelValue":a[1]||(a[1]=t=>n.value.filiere=t),required:""},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez une filière"})]),_:1}),l(r(C),null,{default:i(()=>[(f(!0),c(V,null,h(q.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(N,null,{default:i(()=>[l(r(g),{for:"classe"},{default:i(()=>[a[10]||(a[10]=d("Classe",-1)),l(I)]),_:1}),l(r(y),{modelValue:n.value.classe,"onUpdate:modelValue":a[2]||(a[2]=t=>n.value.classe=t),required:""},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez une classe"})]),_:1}),l(r(C),null,{default:i(()=>[(f(!0),c(V,null,h(te.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(N,null,{default:i(()=>[l(r(g),{for:"apprenant"},{default:i(()=>[a[11]||(a[11]=d("Élève",-1)),l(I)]),_:1}),l(r(y),{modelValue:n.value.apprenant,"onUpdate:modelValue":a[5]||(a[5]=t=>n.value.apprenant=t),required:""},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez un apprenant"})]),_:1}),l(r(C),null,{default:i(()=>[D("div",Se,[l(r(me),{value:_.value,placeholder:"Rechercher un apprenant...",class:"w-full h-8",onInput:a[3]||(a[3]=t=>_.value=t.target.value),onKeydown:a[4]||(a[4]=J(()=>{},["stop"]))},null,8,["value"])]),(f(!0),c(V,null,h(P.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128)),P.value.length===0?(f(),c("div",ge," Aucun apprenant trouvé ")):de("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(N,null,{default:i(()=>[l(r(g),{for:"conduiteSemestre1"},{default:i(()=>[...a[12]||(a[12]=[d("Conduite-semestre 1",-1)])]),_:1}),l(r(y),{modelValue:n.value.conduiteSemestre1,"onUpdate:modelValue":a[6]||(a[6]=t=>n.value.conduiteSemestre1=t)},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez la note"})]),_:1}),l(r(C),null,{default:i(()=>[(f(!0),c(V,null,h(x.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(N,null,{default:i(()=>[l(r(g),{for:"conduiteSemestre2"},{default:i(()=>[...a[13]||(a[13]=[d("Conduite-semestre 2",-1)])]),_:1}),l(r(y),{modelValue:n.value.conduiteSemestre2,"onUpdate:modelValue":a[7]||(a[7]=t=>n.value.conduiteSemestre2=t)},{default:i(()=>[l(r(b),{class:"!h-10 bg-white w-full"},{default:i(()=>[l(r(w),{placeholder:"Sélectionnez la note"})]),_:1}),l(r(C),null,{default:i(()=>[(f(!0),c(V,null,h(x.value,t=>(f(),m(r(A),{key:t.id,value:t.id},{default:i(()=>[d(p(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),D("div",ye,[D("div",be,[l(r(K),{type:"button",variant:"outline",onClick:se},{default:i(()=>[...a[14]||(a[14]=[d(" Annuler ",-1)])]),_:1}),l(r(K),{type:"submit",disabled:r(j)},{default:i(()=>[d(p(r(j)?"Enregistrement...":"Enregistrer la note"),1)]),_:1},8,["disabled"])])])],32)]),_:1}))}});export{Oe as default};
