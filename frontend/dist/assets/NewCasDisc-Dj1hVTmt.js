import{d as de,r as h,a1 as ce,A as c,v as pe,s as f,p as m,x as N,w as r,b as L,f as i,i as l,z as _,y as u,B as $,C as x,D as T,E as k,c as v,F as U,G as q,h as j,g as F,k as H,t as I,a as fe,o as d,J as G}from"./index-CJ_PivE-.js";import{_ as J}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as me}from"./Textarea.vue_vue_type_script_setup_true_lang-Bg8QXdyw.js";import{_ as _e}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as ve}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as g}from"./InputWrapper-tSRHzcjN.js";import{S as y}from"./SpanRequired-COKghTUX.js";import{u as ge}from"./usePostApi-Crg8MURP.js";import{u as ye}from"./usePutApi-BrTvEW5v.js";import{u as b}from"./useGetApi-EdzHoZm6.js";import{e as K}from"./eventBus-CGRXT3Tn.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"p-2"},Ce={key:0,class:"p-2 text-gray-500 text-sm"},Ae={class:"flex items-center justify-end gap-2"},Se={key:0,class:"iconify hugeicons--loading-03 animate-spin mr-2"},ze=de({__name:"NewCasDisc",setup(he){const w=fe(),E=ce(),C=h(!!E.query.edit),A=h(E.query.id?Number(E.query.id):null),o=h({date:"",student_id:0,fault_count:1,action:"",classroom_id:0,school_year_id:0}),{postData:W,loading:O,error:B,success:Q}=ge(),{putData:X,loading:z,error:R,success:Y}=ye(),{data:D,fetchData:Z}=b(c.GET_STUDENTS),{data:V,fetchData:ee}=b(c.GET_CLASSROOMS),{data:p,fetchData:ae}=b(c.GET_SCHOOL_YEARS),{data:P,fetchData:te}=b(c.GET_DISCIPLINARY_ACTIONS);pe(async()=>{if(await Promise.all([Z(),ee(),ae(),te()]),!C.value){const e=se();e&&(o.value.school_year_id=Number(e))}C.value&&A.value&&await ie()});function se(){const e=p==null?void 0:p.value;let t=[];if(Array.isArray(e)?t=e:e&&Array.isArray(e.years)&&(t=e.years),!Array.isArray(t)||t.length===0)return null;const a=t.find(n=>n.active===!0||n.is_active===!0||n.current===!0||n.is_current===!0||n.status==="active");if(a&&a.id!==void 0)return a.id;const s=t.find(n=>String(n.name||"").toLowerCase().includes("en cours")||String(n.name||"").toLowerCase().includes("actuelle"));return s&&s.id!==void 0?s.id:t[0].id??null}const ie=async()=>{try{const e=c.GET_INDISCIPLINE_CASES+`/${A.value}`,{data:t,fetchData:a}=b(e);await a();const s=t.value,n=s&&typeof s=="object"&&"data"in s?s.data:s;n&&(o.value={date:n.date??"",student_id:Number(n.student_id??0),fault_count:Number(n.fault_count??1),action:String(n.action??""),classroom_id:Number(n.classroom_id??0),school_year_id:Number(n.school_year_id??0)})}catch{f({message:"Erreur lors du chargement des données",type:"error"})}},le=m(()=>{var a;const e=D==null?void 0:D.value;return((Array.isArray(e)?e:((a=e==null?void 0:e.students)==null?void 0:a.data)??(e==null?void 0:e.data)??[])||[]).filter(s=>s&&s.id!==void 0&&s.id!==null).map(s=>({id:Number(s.id),label:`${s.name??""} ${s.firstname??""}`.trim()}))}),S=h(""),M=m(()=>{const e=le.value||[];if(!S.value)return e;const t=S.value.toLowerCase();return e.filter(a=>(a.label||"").toLowerCase().includes(t))}),re=m(()=>{var a;const e=V==null?void 0:V.value;return((Array.isArray(e)?e:((a=e==null?void 0:e.classrooms)==null?void 0:a.data)??(e==null?void 0:e.data)??[])||[]).filter(s=>s&&s.id!==void 0&&s.id!==null).map(s=>({id:Number(s.id),label:s.name}))}),ne=m(()=>{const e=p==null?void 0:p.value;return((Array.isArray(e)?e:(e==null?void 0:e.years)??[])||[]).filter(a=>a&&a.id!==void 0&&a.id!==null).map(a=>({id:Number(a.id),label:a.name??a.label}))});m(()=>{var a;const e=P==null?void 0:P.value;return((Array.isArray(e)?e:((a=e==null?void 0:e.actions)==null?void 0:a.data)??(e==null?void 0:e.data)??[])||[]).filter(s=>s&&s.id!==void 0&&s.id!==null).map(s=>({id:Number(s.id),label:s.name??s.label??s.libelle??""}))});const oe=async()=>{try{if(o.value.fault_count=1,C.value&&A.value){const e=c.UPDATE_INDISCIPLINE_CASE.replace(":indisciplineCase",String(A.value));await X(e,o.value),Y.value?(f({message:"Cas d'indiscipline modifié avec succès",type:"success"}),K.emit("indisciplineCaseUpdated"),w.push("/apprenants/operations/gestion-disciplinaire/indiscipline")):R.value&&f({message:R.value,type:"error"})}else await W(c.CREATE_INDISCIPLINE_CASE,o.value),Q.value?(f({message:"Cas d'indiscipline enregistré avec succès",type:"success"}),K.emit("indisciplineCaseUpdated"),w.push("/apprenants/operations/gestion-disciplinaire/indiscipline")):B.value&&f({message:B.value,type:"error"})}catch{f({message:"Une erreur est survenue",type:"error"})}},ue=()=>{w.push("/apprenants/operations/gestion-disciplinaire/indiscipline")};return(e,t)=>(d(),N(_e,{"link-back":"/apprenants/operations/gestion-disciplinaire/indiscipline",title:"Nouveau Cas d'Indiscipline",module:"students","group-route":"/apprenants/operations",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Gestion Disciplinaire",href:"/apprenants/operations/gestion-disciplinaire"},{label:"Cas d'Indiscipline",href:"/apprenants/operations/gestion-disciplinaire/indiscipline"},{label:"Nouveau Cas",href:"/apprenants/operations/gestion-disciplinaire/cas"}]},{default:r(()=>[L("form",{class:"w-full flex flex-col space-y-8",onSubmit:F(oe,["prevent"])},[i(ve,{title:"",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:r(()=>[i(g,null,{default:r(()=>[i(l(_),{for:"school_year_id"},{default:r(()=>[t[7]||(t[7]=u("Année scolaire",-1)),i(y)]),_:1}),i(l($),{modelValue:o.value.school_year_id,"onUpdate:modelValue":t[0]||(t[0]=a=>o.value.school_year_id=a),required:""},{default:r(()=>[i(l(x),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(l(T),{placeholder:"Sélectionnez l'année"})]),_:1}),i(l(k),null,{default:r(()=>[(d(!0),v(q,null,U(ne.value,a=>(d(),N(l(G),{key:a.id,value:a.id},{default:r(()=>[u(I(a.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(g,null,{default:r(()=>[i(l(_),{for:"classroom_id"},{default:r(()=>[t[8]||(t[8]=u("Classe",-1)),i(y)]),_:1}),i(l($),{modelValue:o.value.classroom_id,"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.classroom_id=a),required:""},{default:r(()=>[i(l(x),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(l(T),{placeholder:"Sélectionnez une classe"})]),_:1}),i(l(k),null,{default:r(()=>[(d(!0),v(q,null,U(re.value,a=>(d(),N(l(G),{key:a.id,value:a.id},{default:r(()=>[u(I(a.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(g,null,{default:r(()=>[i(l(_),{for:"student_id"},{default:r(()=>[t[9]||(t[9]=u("Élève",-1)),i(y)]),_:1}),i(l($),{modelValue:o.value.student_id,"onUpdate:modelValue":t[4]||(t[4]=a=>o.value.student_id=a),required:""},{default:r(()=>[i(l(x),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(l(T),{placeholder:"Sélectionnez un apprenant"})]),_:1}),i(l(k),null,{default:r(()=>[L("div",be,[i(l(J),{value:S.value,placeholder:"Rechercher un apprenant...",class:"w-full h-8",onInput:t[2]||(t[2]=a=>S.value=a.target.value),onKeydown:t[3]||(t[3]=F(()=>{},["stop"]))},null,8,["value"])]),(d(!0),v(q,null,U(M.value,a=>(d(),N(l(G),{key:a.id,value:a.id},{default:r(()=>[u(I(a.label),1)]),_:2},1032,["value"]))),128)),M.value.length===0?(d(),v("div",Ce," Aucun apprenant trouvé ")):j("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(g,null,{default:r(()=>[i(l(_),{for:"date"},{default:r(()=>[t[10]||(t[10]=u("Date",-1)),i(y)]),_:1}),i(l(J),{id:"date",modelValue:o.value.date,"onUpdate:modelValue":t[5]||(t[5]=a=>o.value.date=a),type:"date",required:"",class:"w-full"},null,8,["modelValue"])]),_:1}),i(g,{class:"lg:col-span-3"},{default:r(()=>[i(l(_),{for:"action"},{default:r(()=>[t[11]||(t[11]=u("Action/Punition",-1)),i(y)]),_:1}),i(l(me),{id:"action",modelValue:o.value.action,"onUpdate:modelValue":t[6]||(t[6]=a=>o.value.action=a),placeholder:"Décrivez l'action disciplinaire ou la punition...",required:"",class:"w-full min-h-[100px]"},null,8,["modelValue"])]),_:1})]),_:1}),L("div",Ae,[i(l(H),{type:"button",variant:"outline",onClick:ue},{default:r(()=>[...t[12]||(t[12]=[u(" Annuler ",-1)])]),_:1}),i(l(H),{type:"submit",disabled:l(O)||l(z)},{default:r(()=>[l(O)||l(z)?(d(),v("span",Se)):j("",!0),u(" "+I(C.value?"Modifier le cas":"Enregistrer le cas"),1)]),_:1},8,["disabled"])])],32)]),_:1}))}});export{ze as default};
