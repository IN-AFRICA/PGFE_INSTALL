import{d as ye,u as ge,r as T,q as D,p as h,A as c,v as we,a1 as Ce,s as f,Q,x as C,w as u,b as J,f as a,i as r,z as n,y as s,B as S,C as E,D as V,E as N,c as y,F as M,G as A,k as W,t as p,g as he,a as Se,o as m,J as P}from"./index-CJ_PivE-.js";import{_ as v}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as Ee}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as Y}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as _}from"./InputWrapper-tSRHzcjN.js";import{S as g}from"./SpanRequired-COKghTUX.js";import{u as U}from"./useGetApi-EdzHoZm6.js";import{u as Ve}from"./usePostApi-Crg8MURP.js";import{u as Ne}from"./usePutApi-BrTvEW5v.js";import{e as H}from"./eventBus-CGRXT3Tn.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Me={class:"flex items-center justify-end gap-2"},Ae={key:0},Pe={key:1},We=ye({__name:"NewCourseForm",setup(Ue){const I=Se(),$=Ce(),q=ge(),l=T({label:"",cycle_id:0,level_id:0,filiere_id:0,classroom_id:0,teacher_id:0,hourly_volume:0,max_period_1:0,max_period_2:0,max_period_3:0,max_period_4:0,max_exam_1:0,max_exam_2:0});D(()=>l.value.max_period_1,i=>{const e=Number(i)||0;l.value.max_period_2=e,l.value.max_period_3=e,l.value.max_period_4=e,l.value.max_exam_1=e*2,l.value.max_exam_2=e*2},{immediate:!0}),h(()=>q.userSchoolId);const{data:K,fetchData:X}=U(c.GET_CYCLES),{data:Z,fetchData:ee}=U(c.GET_ACADEMIC_LEVELS),{data:F,fetchData:le}=U(c.GET_FILLIERES),{data:ae,fetchData:re}=U(c.GET_CLASSROOMS),{data:ue,fetchData:oe}=U(c.GET_PERSONNELS_ACADEMIQUES),w=i=>i?Array.isArray(i)?i:i.data&&Array.isArray(i.data)?i.data:[]:[],ie=h(()=>w(F.value)),te=h(()=>{if(!l.value.filiere_id)return[];const e=w(F.value).find(d=>String(d.id)===String(l.value.filiere_id));return e!=null&&e.cycles&&e.cycles.length>0?e.cycles:w(K.value).filter(d=>String(d.filiaire_id)===String(l.value.filiere_id))}),se=h(()=>{if(!l.value.cycle_id)return[];const e=w(F.value).find(d=>String(d.id)===String(l.value.filiere_id));if(e!=null&&e.cycles){const d=e.cycles.find(L=>String(L.id)===String(l.value.cycle_id));if(d!=null&&d.academic_levels&&d.academic_levels.length>0)return d.academic_levels}return w(Z.value).filter(d=>String(d.cycle_id)===String(l.value.cycle_id))}),de=h(()=>{const i=w(ae.value);return l.value.level_id?i.filter(e=>String(e.academic_level_id)===String(l.value.level_id)):[]});D(()=>l.value.filiere_id,(i,e)=>{!b.value&&e!==void 0&&i!==e&&(l.value.cycle_id=0,l.value.level_id=0,l.value.classroom_id=0)}),D(()=>l.value.cycle_id,(i,e)=>{!b.value&&e!==void 0&&i!==e&&(l.value.level_id=0,l.value.classroom_id=0)}),D(()=>l.value.level_id,(i,e)=>{!b.value&&e!==void 0&&i!==e&&(l.value.classroom_id=0)});const{postData:ne,loading:O,error:z,response:me,success:_e,status:R,errorDetails:B}=Ve(),{putData:fe,loading:j,error:G,response:ce,success:pe}=Ne(),x=T(!1),k=T(null),b=T(!1);we(async()=>{await Promise.all([X(),ee(),le(),re(),oe()]),$.query.edit==="true"&&$.query.id&&(x.value=!0,k.value=Number($.query.id),await ve(k.value))});const ve=async i=>{try{console.log("[NewCourseForm] Loading course with ID:",i);const e=c.GET_COURSE.replace(":course",String(i));console.log("[NewCourseForm] API URL:",e);const d=await fetch(`https://enabeltest.inafrica.tech/api/v1${e}`,{headers:{Authorization:`Bearer ${q.token}`,"Content-Type":"application/json"}});if(!d.ok)throw new Error("Erreur lors du chargement du cours");const L=await d.json(),t=L.data||L;if(console.log("[NewCourseForm] Course data loaded:",t),t&&t.error){console.error("[NewCourseForm] Backend error:",t.error),f({message:"Erreur backend: Le modèle Course a une relation incorrecte.",type:"error"}),b.value=!1;return}t&&!t.error?(b.value=!0,await Q(),l.value={label:t.label||"",cycle_id:Number(t.cycle_id)||0,level_id:Number(t.academic_level_id)||0,filiere_id:Number(t.filiaire_id)||0,classroom_id:Number(t.classroom_id)||0,teacher_id:Number(t.teacher_id)||0,hourly_volume:Number(t.hourly_volume)||0,max_period_1:Number(t.max_period_1)||0,max_period_2:Number(t.max_period_2)||0,max_period_3:Number(t.max_period_3)||0,max_period_4:Number(t.max_period_4)||0,max_exam_1:Number(t.max_exam_1)||0,max_exam_2:Number(t.max_exam_2)||0},console.log("[NewCourseForm] Form pre-filled with:",l.value),await Q(),setTimeout(()=>{b.value=!1,console.log("[NewCourseForm] Edit mode ready")},200)):console.warn("[NewCourseForm] No data returned from API")}catch(e){console.error("[NewCourseForm] Error loading course:",e),f({message:"Erreur lors du chargement du cours",type:"error"}),b.value=!1}},xe=()=>{I.push("/apprenants/saisie-prealable/cours")},be=async()=>{if(!q.isAuthenticated){f({message:"vous devez etre connecté pour créer un cours",type:"error"}),I.push("/auth/login");return}if(!l.value.label.trim()){f({message:"Le libellé du cours est requis",type:"error"});return}if(!l.value.cycle_id||!l.value.level_id||!l.value.filiere_id||!l.value.classroom_id||!l.value.teacher_id){f({message:"Tous les champs obligatoires doivent être remplis",type:"error"});return}if(l.value.hourly_volume<=0){f({message:"Le nombre d'heure doit être supérieur à 0",type:"error"});return}try{const i={label:l.value.label,academic_level_id:l.value.level_id,filiaire_id:l.value.filiere_id,cycle_id:l.value.cycle_id,classroom_id:l.value.classroom_id,teacher_id:l.value.teacher_id,hourly_volume:l.value.hourly_volume,max_period_1:l.value.max_period_1,max_period_2:l.value.max_period_2,max_period_3:l.value.max_period_3,max_period_4:l.value.max_period_4,max_exam_1:l.value.max_exam_1,max_exam_2:l.value.max_exam_2};if(console.log("Payload envoyé:",i),x.value&&k.value){const e=c.UPDATE_COURSE.replace(":course",String(k.value));if(await fe(e,i),G.value){console.error("Erreur API:",G.value),f({message:G.value,type:"error"});return}pe.value&&(console.log("✅ Cours modifié:",ce.value),f({message:"Cours modifié avec succès",type:"success"}),H.emit("courseUpdated"),I.push("/apprenants/saisie-prealable/cours"))}else{if(await ne(c.CREATE_COURSE,i),z.value){console.error("Erreur API:",{message:z.value,status:R==null?void 0:R.value,details:B==null?void 0:B.value}),f({message:z.value,type:"error"});return}_e.value&&(console.log("✅ Cours créé:",me.value),f({message:"Cours créé avec succès",type:"success"}),H.emit("courseUpdated"),I.push("/apprenants/saisie-prealable/cours"))}}catch{f({message:`Erreur lors de ${x.value?"la modification":"la création"} du cours`,type:"error"})}};return(i,e)=>(m(),C(Ee,{"link-back":"/apprenants/saisie-prealable/cours",title:x.value?"Édition du Cours":"Nouveau Cours","group-route":"/apprenants/saisie-prealable",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Saisie Préalable",href:"/apprenants/saisie-prealable"},{label:"Cours",href:"/apprenants/saisie-prealable/cours"},{label:x.value?"Édition du Cours":"Nouveau Cours",href:"/apprenants/saisie-prealable/cours/nouveau"}]},{default:u(()=>[J("form",{onSubmit:he(be,["prevent"]),class:"w-full flex flex-col space-y-8"},[a(Y,{title:"Informations générales",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:u(()=>[a(_,null,{default:u(()=>[a(r(n),{for:"label"},{default:u(()=>[e[13]||(e[13]=s("Libellé du cours",-1)),a(g)]),_:1}),a(r(v),{id:"label",modelValue:l.value.label,"onUpdate:modelValue":e[0]||(e[0]=o=>l.value.label=o),type:"text",placeholder:"Entrez le libellé du cours",required:"",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"filiere_id"},{default:u(()=>[e[14]||(e[14]=s("Section",-1)),a(g)]),_:1}),a(r(S),{modelValue:l.value.filiere_id,"onUpdate:modelValue":e[1]||(e[1]=o=>l.value.filiere_id=o),required:""},{default:u(()=>[a(r(E),{class:"!h-10 bg-white w-full"},{default:u(()=>[a(r(V),{placeholder:"Sélectionnez une section"})]),_:1}),a(r(N),null,{default:u(()=>[(m(!0),y(A,null,M(ie.value,o=>(m(),C(r(P),{key:o.id,value:Number(o.id)},{default:u(()=>[s(p(o.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"cycle_id"},{default:u(()=>[e[15]||(e[15]=s("Cycle",-1)),a(g)]),_:1}),a(r(S),{modelValue:l.value.cycle_id,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.cycle_id=o),disabled:!l.value.filiere_id,required:""},{default:u(()=>[a(r(E),{class:"!h-10 bg-white w-full"},{default:u(()=>[a(r(V),{placeholder:l.value.filiere_id?"Sélectionnez un cycle":"Sélectionnez d'abord une section"},null,8,["placeholder"])]),_:1}),a(r(N),null,{default:u(()=>[(m(!0),y(A,null,M(te.value,o=>(m(),C(r(P),{key:o.id,value:Number(o.id)},{default:u(()=>[s(p(o.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"level_id"},{default:u(()=>[e[16]||(e[16]=s("Niveau scolaire",-1)),a(g)]),_:1}),a(r(S),{modelValue:l.value.level_id,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.level_id=o),disabled:!l.value.cycle_id,required:""},{default:u(()=>[a(r(E),{class:"!h-10 bg-white w-full"},{default:u(()=>[a(r(V),{placeholder:l.value.cycle_id?"Sélectionnez un niveau":"Sélectionnez d'abord un cycle"},null,8,["placeholder"])]),_:1}),a(r(N),null,{default:u(()=>[(m(!0),y(A,null,M(se.value,o=>(m(),C(r(P),{key:o.id,value:Number(o.id)},{default:u(()=>[s(p(o.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"classroom_id"},{default:u(()=>[e[17]||(e[17]=s("Classe",-1)),a(g)]),_:1}),a(r(S),{modelValue:l.value.classroom_id,"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.classroom_id=o),disabled:!l.value.level_id,required:""},{default:u(()=>[a(r(E),{class:"!h-10 bg-white w-full"},{default:u(()=>[a(r(V),{placeholder:l.value.level_id?"Sélectionnez une classe":"Sélectionnez d'abord un niveau"},null,8,["placeholder"])]),_:1}),a(r(N),null,{default:u(()=>[(m(!0),y(A,null,M(de.value,o=>(m(),C(r(P),{key:o.id,value:Number(o.id)},{default:u(()=>[s(p(o.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"teacher_id"},{default:u(()=>[e[18]||(e[18]=s("Enseignant",-1)),a(g)]),_:1}),a(r(S),{modelValue:l.value.teacher_id,"onUpdate:modelValue":e[5]||(e[5]=o=>l.value.teacher_id=o),required:""},{default:u(()=>[a(r(E),{class:"!h-10 bg-white w-full"},{default:u(()=>[a(r(V),{placeholder:"Sélectionnez un enseignant"})]),_:1}),a(r(N),null,{default:u(()=>[(m(!0),y(A,null,M(r(ue),o=>(m(),C(r(P),{key:o.id,value:Number(o.id)},{default:u(()=>[s(p(o.name)+" "+p(o.firstname),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"hourly_volume"},{default:u(()=>[e[19]||(e[19]=s("Nombre d'heure",-1)),a(g)]),_:1}),a(r(v),{id:"hourly_volume",modelValue:l.value.hourly_volume,"onUpdate:modelValue":e[6]||(e[6]=o=>l.value.hourly_volume=o),modelModifiers:{number:!0},type:"number",min:"1",placeholder:"Nombre d'heure en heures",required:"",class:"w-full"},null,8,["modelValue"])]),_:1})]),_:1}),a(Y,{title:"Maximums par période et examen",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:u(()=>[a(_,null,{default:u(()=>[a(r(n),{for:"max_period_1"},{default:u(()=>[...e[20]||(e[20]=[s("Maximum Période 1",-1)])]),_:1}),a(r(v),{id:"max_period_1",modelValue:l.value.max_period_1,"onUpdate:modelValue":e[7]||(e[7]=o=>l.value.max_period_1=o),modelModifiers:{number:!0},type:"number",min:"0",placeholder:"Maximum P1",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"max_period_2"},{default:u(()=>[...e[21]||(e[21]=[s("Maximum Période 2",-1)])]),_:1}),a(r(v),{id:"max_period_2",modelValue:l.value.max_period_2,"onUpdate:modelValue":e[8]||(e[8]=o=>l.value.max_period_2=o),modelModifiers:{number:!0},type:"text",min:"0",placeholder:"Maximum P2",readonly:!0,tabindex:-1,"aria-disabled":"true",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"max_exam_1"},{default:u(()=>[...e[22]||(e[22]=[s("Maximum Examen 1",-1)])]),_:1}),a(r(v),{id:"max_exam_1",modelValue:l.value.max_exam_1,"onUpdate:modelValue":e[9]||(e[9]=o=>l.value.max_exam_1=o),modelModifiers:{number:!0},type:"text",min:"0",placeholder:"Maximum E1",readonly:!0,tabindex:-1,"aria-disabled":"true",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"max_period_3"},{default:u(()=>[...e[23]||(e[23]=[s("Maximum Période 3",-1)])]),_:1}),a(r(v),{id:"max_period_3",modelValue:l.value.max_period_3,"onUpdate:modelValue":e[10]||(e[10]=o=>l.value.max_period_3=o),modelModifiers:{number:!0},type:"text",min:"0",placeholder:"Maximum P3",readonly:!0,tabindex:-1,"aria-disabled":"true",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"max_period_4"},{default:u(()=>[...e[24]||(e[24]=[s("Maximum Période 4",-1)])]),_:1}),a(r(v),{id:"max_period_4",modelValue:l.value.max_period_4,"onUpdate:modelValue":e[11]||(e[11]=o=>l.value.max_period_4=o),modelModifiers:{number:!0},type:"text",min:"0",placeholder:"Maximum P4",readonly:!0,tabindex:-1,"aria-disabled":"true",class:"w-full"},null,8,["modelValue"])]),_:1}),a(_,null,{default:u(()=>[a(r(n),{for:"max_exam_2"},{default:u(()=>[...e[25]||(e[25]=[s("Maximum Examen 2",-1)])]),_:1}),a(r(v),{id:"max_exam_2",modelValue:l.value.max_exam_2,"onUpdate:modelValue":e[12]||(e[12]=o=>l.value.max_exam_2=o),modelModifiers:{number:!0},type:"text",min:"0",placeholder:"Maximum E2",readonly:!0,tabindex:-1,"aria-disabled":"true",class:"w-full"},null,8,["modelValue"])]),_:1})]),_:1}),J("div",Me,[a(r(W),{type:"button",variant:"outline",onClick:xe},{default:u(()=>[...e[26]||(e[26]=[s(" Annuler ",-1)])]),_:1}),a(r(W),{type:"submit",disabled:r(O)||r(j)},{default:u(()=>[r(O)||r(j)?(m(),y("span",Ae,p(x.value?"Modification...":"Création..."),1)):(m(),y("span",Pe,p(x.value?"Modifier le cours":"Créer le cours"),1))]),_:1},8,["disabled"])])],32)]),_:1},8,["title","breadcrumb"]))}});export{We as default};
