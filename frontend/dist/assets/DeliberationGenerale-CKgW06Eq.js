import{d as _e,p as u,a1 as pe,A as N,r as O,v as ve,s as V,a as ge,x as H,w as l,c as _,h as Y,f as a,i as s,b as r,t as c,y as n,k as be,H as g,G as ye,F as xe,U as he,V as ke,W as we,X as $e,z as b,Y as Ce,Z as De,R as Ne,o as f}from"./index-CJ_PivE-.js";import{_ as y}from"./index-BeOV968Y.js";import{_ as Ve,a as Ee,b as K,c as E,d as Ae,e as A}from"./TableHeader.vue_vue_type_script_setup_true_lang-cS4zBTGx.js";import{_ as W}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{_ as Te}from"./AlertDialogAction.vue_vue_type_script_setup_true_lang-DdUVYLnm.js";import{_ as Ge}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as T}from"./Checkbox.vue_vue_type_script_setup_true_lang-DTckireD.js";import{_ as Re}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{u as X}from"./useGetApi-EdzHoZm6.js";import{u as Ie}from"./usePostApi-Crg8MURP.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./index-BpkKmY4O.js";import"./RovingFocusGroup-BxePylpC.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";const Se={key:0,class:"flex flex-col items-center justify-center py-10 bg-white rounded-md text-gray-500"},qe={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6"},Ue={class:"flex items-center gap-2 text-red-800"},Be={key:2,class:"w-full flex flex-col space-y-8"},Fe={class:"flex items-center"},Le={class:"ml-auto text-right"},Pe={class:"text-xl font-semibold text-foreground-title"},je={class:"text-md text-gray-500"},ze={class:"space-y-6"},Me={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},Oe={class:"text-center"},He={class:"text-2xl font-bold mb-1"},Ye={class:"text-center"},Ke={class:"text-lg font-semibold mb-1"},We={class:"text-center"},Xe={class:"text-center"},Ze={class:"text-lg font-semibold mb-1"},Je={class:"space-y-4 py-4"},Qe={class:"space-y-2"},es={class:"flex items-center space-x-2"},ss={class:"flex items-center space-x-2"},ts={class:"flex items-center space-x-2"},as={key:0,class:"iconify hugeicons--loading-03 animate-spin mr-2"},hs=_e({__name:"DeliberationGenerale",setup(ls){const m=pe(),Z=ge(),x=u(()=>m.params.studentId),p=u(()=>m.query.classroom_id),v=u(()=>m.query.school_year_id),G=u(()=>m.query.skip_missing==="true"),R=u(()=>m.query.weight_by_hourly==="true"),J=u(()=>m.query.student_name||""),Q=u(()=>m.query.classroom_name||""),ee=u(()=>m.query.filiere_name||""),{data:h,fetchData:se}=X(N.GET_STUDENT_REGISTRATIONS),k=u(()=>{var B,F,L,P,j,z,M;const o=h==null?void 0:h.value,e=Array.isArray(o)?o:o!=null&&o.data&&Array.isArray(o.data)?o.data:[],t=(e==null?void 0:e[0])||{},U=[(B=t.student)==null?void 0:B.name,(F=t.student)==null?void 0:F.lastname,(L=t.student)==null?void 0:L.firstname].filter(Boolean),ce=U.length?U.join(" "):t.student_name||"",me=typeof t.classroom=="object"?((P=t.classroom)==null?void 0:P.name)||((j=t.classroom)==null?void 0:j.label)||"":t.classroom_name||t.classroom||"",fe=typeof t.filiaire=="object"?((z=t.filiaire)==null?void 0:z.name)||((M=t.filiaire)==null?void 0:M.label)||"":t.filiaire_name||t.filiere_name||t.filiale_name||t.filiaire||"";return{student:ce,classroom:me,filiere:fe}}),te=u(()=>J.value||k.value.student),ae=u(()=>Q.value||k.value.classroom),le=u(()=>ee.value||k.value.filiere),{data:re,loading:oe,error:I,fetchData:w}=X(N.GET_GENERAL_DELIB_STUDENT.replace(":student",x.value)),{postData:ie,loading:S,error:q,success:ne}=Ie(),$=O(!1),d=O({threshold:50,weight_by_hourly:!1,skip_missing:!1,force:!1}),i=u(()=>{const o=re.value;if(o)return o.data?o.data:o}),de=(o,e)=>o?"bg-green-100 text-green-800 border-green-200":e?"bg-orange-100 text-orange-800 border-orange-200":"bg-red-100 text-red-800 border-red-200",C=(o,e)=>o>=e?"pass":o>=e*.7?"alert":"fail",D=o=>{switch(o){case"pass":return"bg-green-100 text-green-800 border-green-200";case"alert":return"bg-orange-100 text-orange-800 border-orange-200";default:return"bg-red-100 text-red-800 border-red-200"}},ue=async(o=!1)=>{if(!i.value)return;const e={classroom_id:Number(p.value),school_year_id:Number(v.value),threshold:d.value.threshold,weight_by_hourly:d.value.weight_by_hourly,skip_missing:d.value.skip_missing,force:o},t=N.VALIDATE_GENERAL_DELIB_STUDENT.replace(":student",x.value);await ie(t,e),ne.value?(V({message:o?"Validation forcée avec succès":"Validation effectuée avec succès",type:"success"}),$.value=!1,await w({classroom_id:p.value,school_year_id:v.value,skip_missing:G.value,weight_by_hourly:R.value})):q.value&&V({message:q.value||"Erreur lors de la validation",type:"error"})};return ve(async()=>{if(!p.value||!v.value){V({message:"Paramètres manquants (classe ou année scolaire)",type:"error"}),Z.back();return}await w({classroom_id:p.value,school_year_id:v.value,skip_missing:G.value,weight_by_hourly:R.value}),await se({student_id:x.value})}),(o,e)=>(f(),H(Re,{title:"Délibération Générale","link-back":"/apprenants/operations/deliberation","group-route":"/apprenants/operations",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Délibération",href:"/apprenants/operations/deliberation"},{label:"Délibération Générale",href:"#"}]},{default:l(()=>[s(oe)?(f(),_("div",Se,[...e[6]||(e[6]=[r("svg",{class:"animate-spin h-6 w-6 text-gray-400 mb-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[r("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),r("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8z"})],-1),r("span",null,"Chargement de la délibération générale...",-1)])])):s(I)?(f(),_("div",qe,[r("div",Ue,[e[7]||(e[7]=r("span",{class:"iconify hugeicons--alert-circle"},null,-1)),r("span",null,c(s(I)||"Erreur lors du chargement de la délibération"),1)]),a(s(be),{variant:"outline",class:"mt-3",onClick:s(w)},{default:l(()=>[...e[8]||(e[8]=[n(" Réessayer ",-1)])]),_:1},8,["onClick"])])):i.value?(f(),_("div",Be,[r("div",Fe,[r("div",Le,[r("h2",Pe,c(te.value||"-"),1),r("p",je,c(ae.value||"-")+" · "+c(le.value||"-"),1)])]),r("div",ze,[a(W,{title:"Synthèse générale"},{default:l(()=>[r("div",Me,[r("div",Oe,[r("div",He,[a(s(y),{class:g(D(C(i.value.overall_percentage,i.value.threshold))+" px-2 py-1 text-xs font-medium border")},{default:l(()=>[n(c(i.value.overall_percentage.toFixed(2))+"% ",1)]),_:1},8,["class"])]),e[9]||(e[9]=r("p",{class:"text-sm text-gray-600"},"Pourcentage global",-1))]),r("div",Ye,[r("div",Ke,c(i.value.threshold)+"%",1),e[10]||(e[10]=r("p",{class:"text-sm text-gray-600"},"Seuil requis",-1))]),r("div",We,[a(s(y),{class:g(de(i.value.validated,i.value.eligible_for_validation)+" px-2 py-1 text-xs font-medium border")},{default:l(()=>[n(c(i.value.validated?"Validé":i.value.eligible_for_validation?"Éligible":"Non éligible"),1)]),_:1},8,["class"]),e[11]||(e[11]=r("p",{class:"text-sm text-gray-600 mt-1"},"État de validation",-1))]),r("div",Xe,[r("div",Ze,c(i.value.counts.included)+"/"+c(i.value.counts.total_courses),1),e[12]||(e[12]=r("p",{class:"text-sm text-gray-600"},"Cours inclus",-1))])])]),_:1}),e[16]||(e[16]=r("div",{class:"w-full flex h-px bg-gray-300"},null,-1)),a(W,{title:`Détail par Cours ( ${i.value.counts.skipped} cours ignoré(s) )`},{default:l(()=>[a(s(Ve),null,{default:l(()=>[a(s(Ee),null,{default:l(()=>[a(s(K),null,{default:l(()=>[a(s(E),null,{default:l(()=>[...e[13]||(e[13]=[n("Cours",-1)])]),_:1}),a(s(E),{class:"text-center"},{default:l(()=>[...e[14]||(e[14]=[n("Pourcentage",-1)])]),_:1}),a(s(E),{class:"text-center"},{default:l(()=>[...e[15]||(e[15]=[n("État",-1)])]),_:1})]),_:1})]),_:1}),a(s(Ae),null,{default:l(()=>[(f(!0),_(ye,null,xe(i.value.breakdown,t=>(f(),H(s(K),{key:t.course_id},{default:l(()=>[a(s(A),{class:"font-medium"},{default:l(()=>[n(c(t.label),1)]),_:2},1024),a(s(A),{class:"text-center"},{default:l(()=>[a(s(y),{class:g(D(C(t.percentage,i.value.threshold))+" px-2 py-1 text-xs font-medium border")},{default:l(()=>[n(c(t.percentage.toFixed(2))+"% ",1)]),_:2},1032,["class"])]),_:2},1024),a(s(A),{class:"text-center"},{default:l(()=>[a(s(y),{class:g(D(C(t.percentage,i.value.threshold))+" px-2 py-1 text-xs font-medium border")},{default:l(()=>[n(c(t.percentage>=i.value.threshold?"Réussi":"Échec"),1)]),_:2},1032,["class"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["title"])]),e[17]||(e[17]=r("div",{class:"w-full flex h-px bg-gray-300"},null,-1))])):Y("",!0),a(s(Ne),{open:$.value,"onUpdate:open":e[5]||(e[5]=t=>$.value=t)},{default:l(()=>[a(s(he),null,{default:l(()=>[a(s(ke),null,{default:l(()=>[a(s(we),null,{default:l(()=>[...e[18]||(e[18]=[n("Valider la délibération générale",-1)])]),_:1}),a(s($e),null,{default:l(()=>[...e[19]||(e[19]=[n(" Configurez les paramètres de validation pour cet élève. ",-1)])]),_:1})]),_:1}),r("div",Je,[r("div",Qe,[a(s(b),{for:"threshold"},{default:l(()=>[...e[20]||(e[20]=[n("Seuil de validation (%)",-1)])]),_:1}),a(s(Ge),{id:"threshold",type:"number",min:"0",max:"100",modelValue:d.value.threshold,"onUpdate:modelValue":e[0]||(e[0]=t=>d.value.threshold=t),modelModifiers:{number:!0}},null,8,["modelValue"])]),r("div",es,[a(s(T),{id:"weight_by_hourly",checked:d.value.weight_by_hourly,"onUpdate:checked":e[1]||(e[1]=t=>d.value.weight_by_hourly=t)},null,8,["checked"]),a(s(b),{for:"weight_by_hourly"},{default:l(()=>[...e[21]||(e[21]=[n("Pondérer par nombre d'heure",-1)])]),_:1})]),r("div",ss,[a(s(T),{id:"skip_missing",checked:d.value.skip_missing,"onUpdate:checked":e[2]||(e[2]=t=>d.value.skip_missing=t)},null,8,["checked"]),a(s(b),{for:"skip_missing"},{default:l(()=>[...e[22]||(e[22]=[n("Ignorer les notes manquantes",-1)])]),_:1})]),r("div",ts,[a(s(T),{id:"force",checked:d.value.force,"onUpdate:checked":e[3]||(e[3]=t=>d.value.force=t)},null,8,["checked"]),a(s(b),{for:"force"},{default:l(()=>[...e[23]||(e[23]=[n("Forcer la validation (même si non éligible)",-1)])]),_:1})])]),a(s(Ce),null,{default:l(()=>[a(s(De),null,{default:l(()=>[...e[24]||(e[24]=[n("Annuler",-1)])]),_:1}),a(s(Te),{onClick:e[4]||(e[4]=t=>ue(d.value.force)),disabled:s(S)},{default:l(()=>[s(S)?(f(),_("span",as)):Y("",!0),n(" "+c(d.value.force?"Forcer la validation":"Valider"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])]),_:1}))}});export{hs as default};
