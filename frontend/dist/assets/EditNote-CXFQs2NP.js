import{d as ie,r as D,a1 as re,A as c,v as ue,p as m,x as p,w as s,c as d,b as f,f as l,i as n,z as v,y as u,B as g,C as S,D as y,E as b,G as N,F as E,h as de,g as H,k as J,m as fe,s as V,a as me,o as r,J as w,t as h}from"./index-CJ_PivE-.js";import{_ as ce}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as pe}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as _e}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as C}from"./InputWrapper-tSRHzcjN.js";import{S as T}from"./SpanRequired-COKghTUX.js";import{S as ve}from"./Spinner-BZtQf9oC.js";import{u as A}from"./useGetApi-EdzHoZm6.js";import{u as ge}from"./usePutApi-BrTvEW5v.js";import{e as Se}from"./eventBus-CGRXT3Tn.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ye={key:0,class:"w-full flex flex-col items-center justify-center py-20"},be={class:"p-2"},Ne={key:0,class:"p-2 text-gray-500 text-sm"},Ee={class:"flex items-center justify-end gap-2"},we={key:0,class:"flex items-center gap-2"},he={key:1},Ce={class:"flex items-center gap-2"},Me=ie({__name:"EditNote",setup(xe){const F=me(),K=re(),k=D(K.params.id),I=D(!1),o=D({anneeScolaire:"",filiere:"",classe:"",apprenant:"",numeroFauteCommise:"",conduiteSemestre1:"",conduiteSemestre2:""}),{data:U,fetchData:W}=A(c.GET_SHOOL_YEARS),{data:$,fetchData:Q}=A(c.GET_FILLIERES),{data:L,fetchData:X}=A(c.GET_CLASSROOMS),{data:O,fetchData:Z}=A(c.GET_STUDENTS),{data:R,fetchData:ee}=A(c.GET_CONDUITE),te=async()=>{I.value=!0;try{console.log("[EditNote] Loading note with ID:",k.value);const{data:e}=await fe.get(c.GET_NOTE_CONDUITE_BY_ID(Number(k.value)));console.log("[EditNote] API Response:",e);const t=e.note||e.data||e.conduite_grade||e;console.log("[EditNote] Extracted note data:",t),t?(await new Promise(a=>setTimeout(a,100)),o.value={anneeScolaire:String(t.school_year_id||""),filiere:String(t.filiere_id||""),classe:String(t.classroom_id||""),apprenant:String(t.student_id||""),numeroFauteCommise:String(t.fault_count||""),conduiteSemestre1:String(t.conduite_semester_1_id||""),conduiteSemestre2:String(t.conduite_semester_2_id||"")},console.log("[EditNote] Form data set:",o.value),console.log("[EditNote] Available years:",q.value),console.log("[EditNote] Available filieres:",B.value),console.log("[EditNote] Available classes:",G.value),console.log("[EditNote] Available students:",z.value)):(console.error("[EditNote] No note data found in response"),V({message:"Aucune donnée trouvée pour cette note",type:"error"}))}catch(e){console.error("[EditNote] Error loading note:",e),V({message:"Erreur lors du chargement de la note",type:"error"})}finally{I.value=!1}};ue(async()=>{console.log("[EditNote] Component mounted, noteId:",k.value),await Promise.all([W(),Q(),X(),Z(),ee()]),console.log("[EditNote] Reference data loaded"),await te()});const q=m(()=>{const e=U==null?void 0:U.value;return(Array.isArray(e)?e:(e==null?void 0:e.years)??[]).map(a=>({id:String(a.id),name:a.name}))}),B=m(()=>{var a;const e=$==null?void 0:$.value;return(Array.isArray(e)?e:((a=e==null?void 0:e.filiaires)==null?void 0:a.data)??(e==null?void 0:e.data)??[]).map(i=>({id:String(i.id),name:i.name}))}),G=m(()=>{var a;const e=L==null?void 0:L.value;return(Array.isArray(e)?e:((a=e==null?void 0:e.classrooms)==null?void 0:a.data)??(e==null?void 0:e.data)??[]).map(i=>({id:String(i.id),name:i.name,filiere_id:i.filiere_id??i.filiereId??null}))}),z=m(()=>{var a;const e=O==null?void 0:O.value;return(Array.isArray(e)?e:((a=e==null?void 0:e.students)==null?void 0:a.data)??(e==null?void 0:e.data)??[]).map(i=>({id:String(i.id),name:`${i.name??""} ${i.firstname??""}`.trim(),classroom_id:i.classroom_id??i.classroomId??null,filiere_id:i.filiere_id??i.filiereId??null}))}),_=D("");m(()=>{const e=z.value||[];if(!_.value)return e;const t=_.value.toLowerCase();return e.filter(a=>(a.name||"").toLowerCase().includes(t))});const M=m(()=>{var a;const e=R==null?void 0:R.value;return(Array.isArray(e)?e:((a=e==null?void 0:e.conduites)==null?void 0:a.data)??(e==null?void 0:e.data)??[]).map(i=>({id:String(i.id??i.value??""),name:i.name??i.label??String(i)}))}),ae=m(()=>{const e=o.value.filiere;return e?G.value.filter(t=>!t.filiere_id||String(t.filiere_id)===String(e)):G.value}),le=m(()=>{const e=o.value.classe,t=o.value.filiere;let a=z.value;if(e){const i=a.filter(x=>x.classroom_id&&String(x.classroom_id)===String(e));if(i.length)return i}if(t){const i=a.filter(x=>x.filiere_id&&String(x.filiere_id)===String(t));if(i.length)return i}return a}),j=m(()=>{const e=le.value||[];if(!_.value)return e;const t=_.value.toLowerCase();return e.filter(a=>(a.name||"").toLowerCase().includes(t))}),{putData:ne,loading:P,error:Y}=ge(),se=async()=>{if(!o.value.anneeScolaire||!o.value.classe||!o.value.apprenant){V({message:"Veuillez remplir tous les champs obligatoires",type:"error"});return}const e={school_year_id:Number(o.value.anneeScolaire),filiere_id:o.value.filiere?Number(o.value.filiere):null,classroom_id:Number(o.value.classe),student_id:Number(o.value.apprenant),fault_count:0,conduite_semester_1_id:o.value.conduiteSemestre1?Number(o.value.conduiteSemestre1):null,conduite_semester_2_id:o.value.conduiteSemestre2?Number(o.value.conduiteSemestre2):null};await ne(c.UPDATE_NOTE_CONDUITE(Number(k.value)),e),Y.value?V({message:Y.value||"Erreur lors de la mise à jour de la note",type:"error"}):(V({message:"Note de conduite mise à jour avec succès",type:"success"}),Se.emit("noteConduiteUpdated"),F.push("/apprenants/operations/gestion-disciplinaire/note-conduite"))},oe=()=>{F.push("/apprenants/operations/gestion-disciplinaire/note-conduite")};return(e,t)=>(r(),p(pe,{"link-back":"/apprenants/operations/gestion-disciplinaire/note-conduite",title:"Modifier la Note de Conduite","group-route":"/apprenants/operations",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Gestion Disciplinaire",href:"/apprenants/operations/gestion-disciplinaire"},{label:"Note de Conduite",href:"/apprenants/operations/gestion-disciplinaire/note-conduite"},{label:"Modifier Note",href:"#"}]},{default:s(()=>[I.value?(r(),d("div",ye,[...t[8]||(t[8]=[f("div",{class:"flex flex-col items-center space-y-4"},[f("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),f("p",{class:"text-gray-600 text-lg"},"Chargement des informations de la note...")],-1)])])):(r(),d("form",{key:1,class:"w-full flex flex-col space-y-8",onSubmit:H(se,["prevent"])},[l(_e,{title:"",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:s(()=>[l(C,null,{default:s(()=>[l(n(v),{for:"anneeScolaire"},{default:s(()=>[t[9]||(t[9]=u("Année scolaire",-1)),l(T)]),_:1}),l(n(g),{modelValue:o.value.anneeScolaire,"onUpdate:modelValue":t[0]||(t[0]=a=>o.value.anneeScolaire=a),required:""},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez l'année"})]),_:1}),l(n(b),null,{default:s(()=>[(r(!0),d(N,null,E(q.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:s(()=>[l(n(v),{for:"filiere"},{default:s(()=>[t[10]||(t[10]=u("Section",-1)),l(T)]),_:1}),l(n(g),{modelValue:o.value.filiere,"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.filiere=a),required:""},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez une filière"})]),_:1}),l(n(b),null,{default:s(()=>[(r(!0),d(N,null,E(B.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:s(()=>[l(n(v),{for:"classe"},{default:s(()=>[t[11]||(t[11]=u("Classe",-1)),l(T)]),_:1}),l(n(g),{modelValue:o.value.classe,"onUpdate:modelValue":t[2]||(t[2]=a=>o.value.classe=a),required:""},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez une classe"})]),_:1}),l(n(b),null,{default:s(()=>[(r(!0),d(N,null,E(ae.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:s(()=>[l(n(v),{for:"apprenant"},{default:s(()=>[t[12]||(t[12]=u("Élève",-1)),l(T)]),_:1}),l(n(g),{modelValue:o.value.apprenant,"onUpdate:modelValue":t[5]||(t[5]=a=>o.value.apprenant=a),required:""},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez un apprenant"})]),_:1}),l(n(b),null,{default:s(()=>[f("div",be,[l(n(ce),{value:_.value,placeholder:"Rechercher un apprenant...",class:"w-full h-8",onInput:t[3]||(t[3]=a=>_.value=a.target.value),onKeydown:t[4]||(t[4]=H(()=>{},["stop"]))},null,8,["value"])]),(r(!0),d(N,null,E(j.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128)),j.value.length===0?(r(),d("div",Ne," Aucun apprenant trouvé ")):de("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:s(()=>[l(n(v),{for:"conduiteSemestre1"},{default:s(()=>[...t[13]||(t[13]=[u("Conduite-semestre 1",-1)])]),_:1}),l(n(g),{modelValue:o.value.conduiteSemestre1,"onUpdate:modelValue":t[6]||(t[6]=a=>o.value.conduiteSemestre1=a)},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez la note"})]),_:1}),l(n(b),null,{default:s(()=>[(r(!0),d(N,null,E(M.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(C,null,{default:s(()=>[l(n(v),{for:"conduiteSemestre2"},{default:s(()=>[...t[14]||(t[14]=[u("Conduite-semestre 2",-1)])]),_:1}),l(n(g),{modelValue:o.value.conduiteSemestre2,"onUpdate:modelValue":t[7]||(t[7]=a=>o.value.conduiteSemestre2=a)},{default:s(()=>[l(n(S),{class:"!h-10 bg-white w-full"},{default:s(()=>[l(n(y),{placeholder:"Sélectionnez la note"})]),_:1}),l(n(b),null,{default:s(()=>[(r(!0),d(N,null,E(M.value,a=>(r(),p(n(w),{key:a.id,value:a.id},{default:s(()=>[u(h(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t[18]||(t[18]=f("div",{class:"w-full flex h-px bg-gray-300"},null,-1)),f("div",Ee,[l(n(J),{type:"button",variant:"outline",onClick:oe},{default:s(()=>[...t[15]||(t[15]=[f("span",{class:"flex iconify hugeicons--cancel-01 mr-1.5"},null,-1),u(" Annuler ",-1)])]),_:1}),l(n(J),{type:"submit",disabled:n(P)},{default:s(()=>[n(P)?(r(),d("span",he,[f("div",Ce,[l(ve),t[17]||(t[17]=f("span",null,"Mise à jour...",-1))])])):(r(),d("span",we,[...t[16]||(t[16]=[f("span",{class:"iconify hugeicons--floppy-disk mr-1"},null,-1),f("span",null,"Mettre à jour",-1)])]))]),_:1},8,["disabled"])])],32))]),_:1}))}});export{Me as default};
