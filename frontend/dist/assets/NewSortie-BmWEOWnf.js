import{d as oe,p as x,a1 as ue,r as A,A as v,v as ne,x as D,w as r,b as $,f as i,i as s,z as f,y as u,B as C,C as U,D as N,E as I,c as q,F as k,G as B,g as P,k as F,t as h,a as de,o as p,J as j,s as g}from"./index-CJ_PivE-.js";import{_ as O}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as me}from"./Textarea.vue_vue_type_script_setup_true_lang-Bg8QXdyw.js";import{_ as fe}from"./DashFormLayout.vue_vue_type_script_setup_true_lang-3V-LyRCQ.js";import{_ as pe}from"./FormSection.vue_vue_type_script_setup_true_lang-C-XSdIg3.js";import{I as c}from"./InputWrapper-tSRHzcjN.js";import{S as _}from"./SpanRequired-COKghTUX.js";import{_ as ce}from"./CustomDatePicker.vue_vue_type_script_setup_true_lang-D0Zgowdp.js";import{u as R}from"./useGetApi-EdzHoZm6.js";import{u as _e}from"./usePostApi-Crg8MURP.js";import{u as ve}from"./usePutApi-BrTvEW5v.js";import{e as X}from"./eventBus-CGRXT3Tn.js";import{S as ge}from"./StudentExitService-D4KBsVc2.js";import"./index-BpkKmY4O.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./FormPageHeader.vue_vue_type_script_setup_true_lang-CAg7Z6LS.js";import"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./PopoverTrigger.vue_vue_type_script_setup_true_lang-DzZWQSaq.js";const Se={class:"p-2"},ye={class:"flex items-center justify-end gap-2"},Le=oe({__name:"NewSortie",setup(xe){const E=de(),w=ue(),d=x(()=>!!w.query.edit),b=x(()=>String(w.query.edit||w.params.id||"")),l=A({date:"",student_id:"",exit_time:"",motif:"",school_year_id:"",semester:""}),{data:m,fetchData:H}=R(v.GET_SCHOOL_YEARS),{data:T,fetchData:J}=R(v.GET_STUDENTS),K=x(()=>{const a=m==null?void 0:m.value;return(Array.isArray(a)?a:(a==null?void 0:a.years)??[]).map(t=>({id:String(t.id),name:t.name}))}),V=x(()=>{var t;const a=T==null?void 0:T.value;return(Array.isArray(a)?a:((t=a==null?void 0:a.students)==null?void 0:t.data)??(a==null?void 0:a.data)??[]).map(n=>({id:String(n.id),name:`${n.name??""} ${n.firstname??""}`.trim()}))}),S=A(""),y=A([]);function W(a){if(S.value=a||"",!S.value)y.value=V.value||[];else{const e=S.value.toLowerCase();y.value=(V.value||[]).filter(t=>(t.name||"").toLowerCase().includes(e))}}const Y=["1er Semestre","2ème Semestre"];ne(async()=>{if(await Promise.all([H(),J()]),y.value=V.value||[],!d.value){const a=le();a&&(l.value.school_year_id=String(a))}d.value&&await Q()});const Q=async()=>{var a;try{let e=null;try{const t=await ge.getStudentExitById(Number(b.value));e=t!=null&&t.data&&typeof t.data=="object"&&"data"in t.data?t.data.data:t==null?void 0:t.data}catch{}if(!e||typeof e!="object"||!("id"in e)){const{data:t,fetchData:n}=R(v.GET_STUDENT_EXIT);await n();const o=t.value;e=(Array.isArray(o)?o:(o==null?void 0:o.data)??[]).find(re=>String(re.id)===b.value)||null}e&&(l.value={date:((a=e.date)!=null&&a.includes("T")?e.date.split("T")[0]:e.date)||"",student_id:String(e.student_id||""),exit_time:e.exit_time?String(e.exit_time).slice(0,5):"",motif:e.motif||"",school_year_id:String(e.school_year_id||""),semester:e.semester||""})}catch(e){console.error("Error loading exit data:",e)}},{postData:Z,loading:G,error:M,success:ee}=_e(),{putData:te,loading:z,error:L,success:ae}=ve(),ie=async()=>{console.log("FormData values:",l.value);const a=[];if(l.value.date||a.push("date"),l.value.student_id||a.push("student_id"),l.value.exit_time||a.push("exit_time"),l.value.motif||a.push("motif"),l.value.school_year_id||a.push("school_year_id"),l.value.semester||a.push("semester"),a.length>0){console.log("Missing fields:",a),g({message:`Champs manquants: ${a.join(", ")}`,type:"error"});return}const e={date:l.value.date,student_id:Number(l.value.student_id),exit_time:l.value.exit_time?String(l.value.exit_time).slice(0,5):"",motif:l.value.motif,school_year_id:Number(l.value.school_year_id),semester:l.value.semester};d.value?(await te(v.UPDATE_STUDENT_EXIT.replace(":studentExitId",b.value),e),L.value?g({message:L.value,type:"error"}):ae.value&&(g({message:"Sortie mise à jour avec succès",type:"success"}),X.emit("studentExitUpdated"),E.push("/apprenants/operations/gestion-disciplinaire"))):(await Z(v.CREATE_STUDENT_EXIT,e),M.value?g({message:M.value,type:"error"}):ee.value&&(g({message:"Sortie créée avec succès",type:"success"}),X.emit("studentExitUpdated"),E.push("/apprenants/operations/gestion-disciplinaire")))},se=()=>{E.push("/apprenants/operations/gestion-disciplinaire")};function le(){const a=m==null?void 0:m.value;let e=[];if(Array.isArray(a)?e=a:a&&Array.isArray(a.years)&&(e=a.years),!Array.isArray(e)||e.length===0)return null;const t=e.find(o=>o.active===!0||o.is_active===!0||o.current===!0||o.is_current===!0||o.status==="active");if(t&&t.id!==void 0)return t.id;const n=e.find(o=>String(o.name||"").toLowerCase().includes("en cours")||String(o.name||"").toLowerCase().includes("actuelle"));return n&&n.id!==void 0?n.id:e[0].id??null}return(a,e)=>(p(),D(fe,{"link-back":"/apprenants/operations/gestion-disciplinaire",title:d.value?"Édition de Sortie d'Élève":"Nouvelle Sortie d'Élève","group-route":"/apprenants/operations",module:"students",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Gestion Disciplinaire",href:"/apprenants/operations/gestion-disciplinaire"},{label:"Sorties d'Élèves",href:"/apprenants/operations/gestion-disciplinaire"},{label:d.value?"Éditer Sortie":"Nouvelle Sortie",href:"/apprenants/operations/gestion-disciplinaire/sortie"}]},{default:r(()=>[$("form",{class:"w-full flex flex-col space-y-8",onSubmit:P(ie,["prevent"])},[i(pe,{title:"",class:"grid sm:grid-cols-2 lg:grid-cols-3 gap-y-6 gap-x-10"},{default:r(()=>[i(c,null,{default:r(()=>[i(s(f),{for:"school_year_id"},{default:r(()=>[e[8]||(e[8]=u("Année scolaire",-1)),i(_)]),_:1}),i(s(C),{modelValue:l.value.school_year_id,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.school_year_id=t),required:""},{default:r(()=>[i(s(U),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(s(N),{placeholder:"Sélectionnez l'année"})]),_:1}),i(s(I),null,{default:r(()=>[(p(!0),q(B,null,k(K.value,t=>(p(),D(s(j),{key:t.id,value:t.id},{default:r(()=>[u(h(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(c,null,{default:r(()=>[i(s(f),{for:"date"},{default:r(()=>[e[9]||(e[9]=u("Date de sortie",-1)),i(_)]),_:1}),i(ce,{id:"date",modelValue:l.value.date,"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.date=t),required:"",class:"w-full"},null,8,["modelValue"])]),_:1}),i(c,null,{default:r(()=>[i(s(f),{for:"exit_time"},{default:r(()=>[e[10]||(e[10]=u("Heure de sortie",-1)),i(_)]),_:1}),i(s(O),{id:"exit_time",modelValue:l.value.exit_time,"onUpdate:modelValue":e[2]||(e[2]=t=>l.value.exit_time=t),type:"time",required:"",class:"w-full"},null,8,["modelValue"])]),_:1}),i(c,null,{default:r(()=>[i(s(f),{for:"student_id"},{default:r(()=>[e[11]||(e[11]=u("Élève",-1)),i(_)]),_:1}),i(s(C),{modelValue:l.value.student_id,"onUpdate:modelValue":e[5]||(e[5]=t=>l.value.student_id=t),required:""},{default:r(()=>[i(s(U),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(s(N),{placeholder:"Sélectionnez un élève"})]),_:1}),i(s(I),null,{default:r(()=>[$("div",Se,[i(s(O),{value:S.value,placeholder:"Rechercher un apprenant...",class:"w-full h-8",onInput:e[3]||(e[3]=t=>W(t.target.value)),onKeydown:e[4]||(e[4]=P(()=>{},["stop"]))},null,8,["value"])]),(p(!0),q(B,null,k(y.value,t=>(p(),D(s(j),{key:t.id,value:t.id},{default:r(()=>[u(h(t.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(c,null,{default:r(()=>[i(s(f),{for:"semestre"},{default:r(()=>[e[12]||(e[12]=u("Semestre ",-1)),i(_)]),_:1}),i(s(C),{modelValue:l.value.semester,"onUpdate:modelValue":e[6]||(e[6]=t=>l.value.semester=t),required:""},{default:r(()=>[i(s(U),{class:"!h-10 bg-white w-full"},{default:r(()=>[i(s(N),{placeholder:"Sélectionnez le semestre"})]),_:1}),i(s(I),null,{default:r(()=>[(p(),q(B,null,k(Y,t=>i(s(j),{key:t,value:t},{default:r(()=>[u(h(t),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(c,null,{default:r(()=>[i(s(f),{for:"motif"},{default:r(()=>[e[13]||(e[13]=u("Motif de la sortie",-1)),i(_)]),_:1}),i(s(me),{id:"motif",modelValue:l.value.motif,"onUpdate:modelValue":e[7]||(e[7]=t=>l.value.motif=t),placeholder:"Décrivez le motif de la sortie...",required:"",class:"w-full min-h-[100px]"},null,8,["modelValue"])]),_:1})]),_:1}),$("div",ye,[i(s(F),{type:"button",variant:"outline",onClick:se},{default:r(()=>[...e[14]||(e[14]=[u(" Annuler ",-1)])]),_:1}),i(s(F),{type:"submit",disabled:s(G)||s(z)},{default:r(()=>[u(h(d.value?s(z)?"Mise à jour...":"Mettre à jour":s(G)?"Enregistrement...":"Enregistrer la sortie"),1)]),_:1},8,["disabled"])])],32)]),_:1},8,["title","breadcrumb"]))}});export{Le as default};
