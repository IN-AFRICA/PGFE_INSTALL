import{d as be,r as w,A as V,p as A,q as le,v as Ue,x as y,w as l,f as n,b as u,i as t,k as Y,y as r,z as L,B as P,C as R,D as T,E as O,c as x,F as k,G as I,t as f,U as Le,V as Pe,W as Re,X as Te,Y as Oe,Z as je,R as Ne,s as $,a as Be,o as i,J as j}from"./index-CJ_PivE-.js";import{_ as Fe}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as Ge,a as Ye,b as z,c as v,d as Me,e as c}from"./TableHeader.vue_vue_type_script_setup_true_lang-cS4zBTGx.js";import{_ as qe,a as Je,b as Ze}from"./PopoverTrigger.vue_vue_type_script_setup_true_lang-DzZWQSaq.js";import{_ as N}from"./SelectGroup.vue_vue_type_script_setup_true_lang-CwIOzTi6.js";import{_ as He}from"./LayoutSaisieOperation.vue_vue_type_script_setup_true_lang-bYPLg6Nt.js";import{_ as Ke}from"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import{u as M}from"./useGetApi-EdzHoZm6.js";import{u as Qe}from"./usePutApi-BrTvEW5v.js";import{u as We}from"./usePostApi-Crg8MURP.js";import{_ as Xe}from"./FilterBadges.vue_vue_type_script_setup_true_lang-CBuiPNtr.js";import{_ as ne}from"./IconifySpinner.vue_vue_type_script_setup_true_lang-C3Td1B5O.js";import"./index-BpkKmY4O.js";import"./DashLayoutWithMode.vue_vue_type_script_setup_true_lang-DzpyZ4TL.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";import"./DashPageHeader.vue_vue_type_script_setup_true_lang-DucYyTAx.js";const et={class:"flex items-center gap-3 justify-between"},tt={class:"flex flex-1 items-center gap-2"},at={class:"relative w-full max-w-xs"},st={class:"grid gap-4"},lt={class:"flex flex-col gap-3.5"},nt={class:"space-y-1.5"},rt={class:"space-y-1.5"},ot={class:"flex flex-wrap items-center gap-2.5"},ut={key:0,class:"flex items-center gap-2"},it={key:1,class:"flex items-center gap-2"},dt={class:"mt-4 rounded-md overflow-hidden flex flex-1 bg-white"},ft={class:"flex gap-2"},ct={class:"relative inline-flex items-center cursor-pointer group"},mt=["checked","onChange","disabled"],vt={class:"group flex items-center justify-between"},_t={class:"hidden group-hover:flex items-center gap-2 ml-2"},pt={class:"flex flex-col gap-4 py-4"},gt={class:"space-y-2"},yt={class:"space-y-2"},xt={class:"space-y-2"},St={key:0,class:"flex items-center gap-2"},wt={key:1,class:"flex items-center gap-2"},re="deliberation_lastState",jt=be({__name:"ListeDeliberation",setup(At){const B=w(""),d=w(""),m=w(""),S=w(""),b=w(!1),{data:oe,loading:ue,error:Z,fetchData:q}=M(V.GET_DELIBERATIONS),{putData:ie,loading:de,error:H,success:fe}=Qe(),{data:h,fetchData:ce}=M(V.GET_CLASSROOMS),{data:p,fetchData:me}=M(V.GET_COURSES),{data:_,fetchData:ve}=M(V.GET_SCHOOL_YEARS),{postData:_e,loading:F,response:pe,error:K}=We(),ge=A(()=>{const s=oe.value||[];return Array.isArray(s)?(s.forEach(e=>{e.cotations&&Array.isArray(e.cotations)&&e.cotations.forEach(a=>{if(typeof a.note=="string")try{a.note=JSON.parse(a.note)}catch{a.note={}}typeof a.note=="number"&&(a.note={})})}),s):[]}),Q=A(()=>{var s;return h.value?Array.isArray(h.value)?h.value:((s=h.value)==null?void 0:s.data)||[]:[]}),ye=A(()=>_.value?Array.isArray(_.value)?_.value:_.value.years&&Array.isArray(_.value.years)?_.value.years:_.value.data&&Array.isArray(_.value.data)?_.value.data:[]:[]),xe=A(()=>{var e;return p.value?d.value?(Array.isArray(p.value)?p.value:((e=p.value)==null?void 0:e.data)||[]).filter(a=>String(a.classroom_id)===String(d.value)):[]:[]}),J=A(()=>{if(!d.value||!m.value)return[];let s=ge.value;if(s=s.filter(e=>{var a;return String((a=e.classroom)==null?void 0:a.id)===String(d.value)}),s=s.filter(e=>{var a;return String((a=e.course)==null?void 0:a.id)===String(m.value)}),B.value){const e=B.value.toLowerCase();s=s.filter(a=>{var E;return(((E=a.student)==null?void 0:E.name)||"").toLowerCase().includes(e)})}return s}),Se=async s=>{const e=s.is_validated==="1"?"0":"1",o=`${V.UPDATE_DELIBERATION.replace(":id",String(s.id))}?student_id=${s.student.id}&is_validated=${e}`;await ie(o,{}),fe.value?(s.is_validated=e,$({message:e==="1"?"Élève validé":"Validation retirée",type:"success"})):H.value&&$({message:H.value||"Erreur lors de la mise à jour",type:"error"})},G=w(!1),g=w(null),C=w(null),D=w(null),we=A(()=>{var e;return p.value?g.value?(Array.isArray(p.value)?p.value:((e=p.value)==null?void 0:e.data)||[]).filter(a=>String(a.classroom_id)===String(g.value)):[]:[]}),Ae=async()=>{if(!g.value||!C.value||!D.value){$({message:"Veuillez sélectionner la classe, le cours et l'année scolaire",type:"error"});return}const s={classroom_id:parseInt(g.value),course_id:parseInt(C.value),school_year_id:parseInt(D.value)};try{if(await _e(V.INITIALIZE_DELIBERATION,s),K.value){$({message:K.value,type:"error"});return}const e=pe.value,a=(e==null?void 0:e.created_count)||0;G.value=!1,b.value=!0,d.value=g.value,m.value=C.value,S.value=D.value,setTimeout(()=>{b.value=!1,he()},100),a>0?$({message:`Délibérations initialisées avec succès (${a} élève(s))`,type:"success"}):$({message:"Les délibérations existent déjà. Chargement en cours...",type:"success"}),await q()}catch(e){console.error("❌ Erreur initialisation:",e),$({message:"Échec de l'initialisation des délibérations",type:"error"})}},$e=()=>{g.value=d.value||null,C.value=m.value||null,D.value=S.value||null,G.value=!0},he=()=>{if(!d.value||!m.value||!S.value)return;const s={classroom_id:d.value,course_id:m.value,school_year_id:S.value,timestamp:Date.now()};localStorage.setItem(re,JSON.stringify(s))},Ce=()=>{const s=localStorage.getItem(re);if(!s)return null;try{return JSON.parse(s)}catch{return null}};le(d,(s,e)=>{!b.value&&e!==void 0&&s!==e&&(m.value="")}),le([d,m],([s,e])=>{s&&e&&q()}),Ue(async()=>{await Promise.all([ce(),me(),ve()]);const s=Ce();s&&(b.value=!0,d.value=s.classroom_id,m.value=s.course_id,S.value=s.school_year_id,await q(),setTimeout(()=>{b.value=!1},500))});const De=A(()=>({school_year_id:S.value||void 0,classroom_id:d.value||void 0,course_id:m.value||void 0})),Ee=A(()=>{var s,e,a,o;return{school_year_id:((s=_.value)==null?void 0:s.years)||((e=_.value)==null?void 0:e.data)||_.value||[],classroom_id:Array.isArray(h.value)?h.value:((a=h.value)==null?void 0:a.data)||[],course_id:Array.isArray(p.value)?p.value:((o=p.value)==null?void 0:o.data)||[]}}),Ve={school_year_id:(s,e)=>{const a=e==null?void 0:e.find(o=>String(o.id)===String(s));return a?`Année: ${a.name}`:String(s)},classroom_id:(s,e)=>{const a=e==null?void 0:e.find(o=>String(o.id)===String(s));return a?`Classe: ${a.name}`:String(s)},course_id:(s,e)=>{const a=e==null?void 0:e.find(o=>String(o.id)===String(s));return a?`Cours: ${a.label||a.name}`:String(s)}},ke=s=>{s==="school_year_id"&&(S.value=""),s==="classroom_id"&&(d.value=""),s==="course_id"&&(m.value="")},Ie=Be(),ze=s=>{var U,W,X,ee,te,ae,se;if(!d.value||!S.value){$({message:"Veuillez sélectionner une classe et une année scolaire",type:"error"});return}const e=[(U=s==null?void 0:s.student)==null?void 0:U.name,(W=s==null?void 0:s.student)==null?void 0:W.lastname,(X=s==null?void 0:s.student)==null?void 0:X.firstname,s==null?void 0:s.student_name].filter(Boolean).join(" ").toString(),a=typeof(s==null?void 0:s.classroom)=="object"?(((ee=s==null?void 0:s.classroom)==null?void 0:ee.name)||((te=s==null?void 0:s.classroom)==null?void 0:te.label)||"").toString():((s==null?void 0:s.classroom)||"").toString(),o=typeof(s==null?void 0:s.filiaire)=="object"?(((ae=s==null?void 0:s.filiaire)==null?void 0:ae.name)||((se=s==null?void 0:s.filiaire)==null?void 0:se.label)||"").toString():((s==null?void 0:s.filiaire)||"").toString(),E=new URLSearchParams({classroom_id:String(d.value),school_year_id:String(S.value),skip_missing:"false",weight_by_hourly:"false",student_name:e,classroom_name:a,filiere_name:o});Ie.push(`/apprenants/operations/deliberation-generale/${s.student.id}?${E.toString()}`)};return(s,e)=>(i(),y(He,{group:"operations","active-tag-name":"deliberation",breadcrumb:[{label:"Élèves",href:"/apprenants"},{label:"Opérations",href:"/apprenants/operations"},{label:"Délibération",href:"/apprenants/operations/deliberation"}]},{default:l(()=>[n(Ke,null,{default:l(()=>[u("div",et,[u("div",tt,[u("div",at,[n(t(Fe),{type:"text",id:"search",name:"search",placeholder:"Rechercher un apprenant...",modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),class:"w-full max-w-xs ps-10 border border-gray-200/40 bg-white transition-all h-10 rounded-md"},null,8,["modelValue"]),e[7]||(e[7]=u("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-foreground-muted/70"},[u("span",{class:"flex iconify hugeicons--search-01 text-sm"})],-1))]),n(t(qe),null,{default:l(()=>[n(t(Je),{"as-child":""},{default:l(()=>[n(t(Y),{variant:"ghost",size:"md",class:"h-10 rounded-md border bg-white"},{default:l(()=>[...e[8]||(e[8]=[r(" Filtre ",-1),u("span",{class:"iconify hugeicons--filter"},"Filtre",-1)])]),_:1})]),_:1}),n(t(Ze),{class:"w-80"},{default:l(()=>[u("div",st,[e[11]||(e[11]=u("div",{class:"space-y-2"},[u("h4",{class:"font-medium leading-none"},"Filtrage"),u("p",{class:"text-sm text-muted-foreground"},"Sélectionnez une classe et un cours pour afficher les délibérations")],-1)),u("div",lt,[u("div",nt,[n(t(L),{class:"text-foreground-muted font-light",for:"classe"},{default:l(()=>[...e[9]||(e[9]=[r("Classe",-1)])]),_:1}),n(t(P),{modelValue:d.value,"onUpdate:modelValue":e[1]||(e[1]=a=>d.value=a)},{default:l(()=>[n(t(R),{id:"classe",class:"!h-10 bg-white w-full"},{default:l(()=>[n(t(T),{placeholder:"Sélectionnez la classe"})]),_:1}),n(t(O),null,{default:l(()=>[n(t(N),null,{default:l(()=>[(i(!0),x(I,null,k(Q.value,a=>(i(),y(t(j),{key:a.id,value:String(a.id)},{default:l(()=>[r(f(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),u("div",rt,[n(t(L),{class:"text-foreground-muted font-light",for:"cours"},{default:l(()=>[...e[10]||(e[10]=[r("Cours",-1)])]),_:1}),n(t(P),{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=a=>m.value=a),disabled:!d.value},{default:l(()=>[n(t(R),{id:"cours",class:"!h-10 bg-white w-full",disabled:!d.value},{default:l(()=>[n(t(T),{placeholder:"Sélectionnez d'abord une classe"})]),_:1},8,["disabled"]),n(t(O),null,{default:l(()=>[n(t(N),null,{default:l(()=>[(i(!0),x(I,null,k(xe.value,a=>(i(),y(t(j),{key:a.id,value:String(a.id)},{default:l(()=>[r(f(a.label||a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue","disabled"])])])])]),_:1})]),_:1}),n(Xe,{filters:De.value,"reference-data":Ee.value,"custom-labels":Ve,onRemoveFilter:ke},null,8,["filters","reference-data"])]),u("div",ot,[n(t(Y),{onClick:$e,size:"md",disabled:t(F)},{default:l(()=>[t(F)?(i(),x("span",it,[n(ne,{size:"sm"}),e[12]||(e[12]=u("span",null,"Initialisation...",-1))])):(i(),x("span",ut," Initialiser "))]),_:1},8,["disabled"])])]),u("div",dt,[n(t(Ge),{class:"rounded-md bg-white"},{default:l(()=>[n(t(Ye),null,{default:l(()=>[n(t(z),null,{default:l(()=>[n(t(v),{class:"min-w-70"},{default:l(()=>[...e[13]||(e[13]=[r("Élève",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[14]||(e[14]=[r("P1",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[15]||(e[15]=[r("P2",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[16]||(e[16]=[r("E1",-1)])]),_:1}),n(t(v),{class:"text-center bg-blue-50/50 font-semibold"},{default:l(()=>[...e[17]||(e[17]=[r("SEM 1",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[18]||(e[18]=[r("P3",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[19]||(e[19]=[r("P4",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[20]||(e[20]=[r("E2",-1)])]),_:1}),n(t(v),{class:"text-center bg-blue-50/50 font-semibold"},{default:l(()=>[...e[21]||(e[21]=[r("SEM 2",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[22]||(e[22]=[r("Moyenne",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[23]||(e[23]=[r("% Annuelle",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[24]||(e[24]=[r("Validation",-1)])]),_:1}),n(t(v),{class:"text-center"},{default:l(()=>[...e[25]||(e[25]=[r("Actions",-1)])]),_:1})]),_:1})]),_:1}),n(t(Me),null,{default:l(()=>[t(ue)?(i(),y(t(z),{key:0},{default:l(()=>[n(t(c),{colspan:"13",class:"text-center py-8 text-gray-500"},{default:l(()=>[...e[26]||(e[26]=[r(" Chargement des délibérations... ",-1)])]),_:1})]),_:1})):t(Z)?(i(),y(t(z),{key:1},{default:l(()=>[n(t(c),{colspan:"13",class:"text-center py-8 text-red-500"},{default:l(()=>[r(" Erreur: "+f(t(Z)),1)]),_:1})]),_:1})):!d.value||!m.value?(i(),y(t(z),{key:2},{default:l(()=>[n(t(c),{colspan:"13",class:"text-center py-8 text-gray-500"},{default:l(()=>[...e[27]||(e[27]=[r(" Veuillez sélectionner une classe et un cours pour afficher les délibérations ",-1)])]),_:1})]),_:1})):!J.value||J.value.length===0?(i(),y(t(z),{key:3},{default:l(()=>[n(t(c),{colspan:"13",class:"text-center py-8 text-gray-500"},{default:l(()=>[...e[28]||(e[28]=[r(" Aucune délibération trouvée pour cette classe et ce cours ",-1)])]),_:1})]),_:1})):(i(!0),x(I,{key:4},k(J.value,a=>(i(),y(t(z),{key:a.id},{default:l(()=>[n(t(c),null,{default:l(()=>{var o,E,U;return[r(f([(o=a.student)==null?void 0:o.name,(E=a.student)==null?void 0:E.lastname,(U=a.student)==null?void 0:U.firstname,a==null?void 0:a.student_name].filter(Boolean).join(" ")||"-"),1)]}),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.P1)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.P2)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.E1)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center bg-blue-50/30 font-semibold"},{default:l(()=>[r(f(a.semestre_1_total??"-"),1)]),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.P3)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.P4)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center"},{default:l(()=>{var o;return[r(f(((o=a.note)==null?void 0:o.E2)??"-"),1)]}),_:2},1024),n(t(c),{class:"text-center bg-blue-50/30 font-semibold"},{default:l(()=>[r(f(a.semestre_2_total??"-"),1)]),_:2},1024),n(t(c),{class:"text-center font-medium"},{default:l(()=>[r(f(a.moyenne_note??"-"),1)]),_:2},1024),n(t(c),{class:"text-center font-semibold"},{default:l(()=>[r(f(a.pourcentage)+"%",1)]),_:2},1024),n(t(c),{class:"flex justify-center items-center"},{default:l(()=>[u("div",ft,[u("label",ct,[u("input",{type:"checkbox",checked:a.is_validated==="1",onChange:o=>Se(a),disabled:t(de),class:"sr-only peer"},null,40,mt),e[29]||(e[29]=u("div",{class:"w-10 h-6 bg-gray-200 rounded-full peer-checked:bg-[#0093db] transition-colors duration-200 group-hover:ring-2 group-hover:ring-[#0093db]"},null,-1)),e[30]||(e[30]=u("div",{class:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"},null,-1))])])]),_:2},1024),n(t(c),null,{default:l(()=>[u("div",vt,[e[32]||(e[32]=u("div",{class:"flex-1"},null,-1)),e[33]||(e[33]=u("button",{class:"ml-2 group-hover:hidden rounded-full size-8 flex items-center justify-center hover:bg-gray-100 transition"},[u("span",{class:"iconify hugeicons--more-vertical-circle-01"})],-1)),u("div",_t,[n(t(Y),{variant:"ghost",size:"icon",class:"size-8 justify-center text-gray-500 hover:text-blue-600 hover:bg-blue-50",onClick:o=>ze(a)},{default:l(()=>[...e[31]||(e[31]=[u("span",{class:"iconify hugeicons--eye"},null,-1)])]),_:1},8,["onClick"])])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})])]),_:1}),n(t(Ne),{open:G.value,"onUpdate:open":e[6]||(e[6]=a=>G.value=a)},{default:l(()=>[n(t(Le),null,{default:l(()=>[n(t(Pe),null,{default:l(()=>[n(t(Re),null,{default:l(()=>[...e[34]||(e[34]=[r("Initialiser les délibérations",-1)])]),_:1}),n(t(Te),null,{default:l(()=>[...e[35]||(e[35]=[r(" Sélectionnez la classe, le cours et l'année scolaire pour initialiser les délibérations. ",-1)])]),_:1})]),_:1}),u("div",pt,[u("div",gt,[n(t(L),{for:"modal-annee"},{default:l(()=>[...e[36]||(e[36]=[r("Année scolaire *",-1)])]),_:1}),n(t(P),{modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=a=>D.value=a)},{default:l(()=>[n(t(R),{id:"modal-annee",class:"!h-10 bg-white"},{default:l(()=>[n(t(T),{placeholder:"Sélectionnez l'année scolaire"})]),_:1}),n(t(O),null,{default:l(()=>[n(t(N),null,{default:l(()=>[(i(!0),x(I,null,k(ye.value,a=>(i(),y(t(j),{key:a.id,value:String(a.id)},{default:l(()=>[r(f(a.name||a.year),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),u("div",yt,[n(t(L),{for:"modal-classe"},{default:l(()=>[...e[37]||(e[37]=[r("Classe *",-1)])]),_:1}),n(t(P),{modelValue:g.value,"onUpdate:modelValue":e[4]||(e[4]=a=>g.value=a)},{default:l(()=>[n(t(R),{id:"modal-classe",class:"!h-10 bg-white"},{default:l(()=>[n(t(T),{placeholder:"Sélectionnez la classe"})]),_:1}),n(t(O),null,{default:l(()=>[n(t(N),null,{default:l(()=>[(i(!0),x(I,null,k(Q.value,a=>(i(),y(t(j),{key:a.id,value:String(a.id)},{default:l(()=>[r(f(a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),u("div",xt,[n(t(L),{for:"modal-cours"},{default:l(()=>[...e[38]||(e[38]=[r("Cours *",-1)])]),_:1}),n(t(P),{modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=a=>C.value=a),disabled:!g.value},{default:l(()=>[n(t(R),{id:"modal-cours",class:"!h-10 bg-white",disabled:!g.value},{default:l(()=>[n(t(T),{placeholder:"Sélectionnez d'abord une classe"})]),_:1},8,["disabled"]),n(t(O),null,{default:l(()=>[n(t(N),null,{default:l(()=>[(i(!0),x(I,null,k(we.value,a=>(i(),y(t(j),{key:a.id,value:String(a.id)},{default:l(()=>[r(f(a.label||a.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue","disabled"])])]),n(t(Oe),null,{default:l(()=>[n(t(je),null,{default:l(()=>[...e[39]||(e[39]=[r("Annuler",-1)])]),_:1}),n(t(Y),{onClick:Ae,disabled:!g.value||!C.value||!D.value||t(F)},{default:l(()=>[t(F)?(i(),x("span",wt,[n(ne,{size:"sm"}),e[40]||(e[40]=u("span",null,"Initialisation...",-1))])):(i(),x("span",St," Initialiser "))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])]),_:1}))}});export{jt as default};
