import{d as ge,r as R,n as _e,A as w,p as y,q as I,u as be,v as ve,a3 as xe,x as j,w as l,f as a,b as o,i as s,k as Q,z as Y,y as r,B as K,C as W,D as X,E as Z,J as g,h as J,t as U,c as M,F as ye,G as he,o as _,H as ee,s as b}from"./index-CJ_PivE-.js";import{_ as te}from"./Input.vue_vue_type_script_setup_true_lang-B9adgRZV.js";import{_ as ke,a as we,b as V,c as A,d as je,e as v}from"./TableHeader.vue_vue_type_script_setup_true_lang-cS4zBTGx.js";import{_ as se}from"./Checkbox.vue_vue_type_script_setup_true_lang-DTckireD.js";import{_ as Ae,a as $e,b as Ne}from"./PopoverTrigger.vue_vue_type_script_setup_true_lang-DzZWQSaq.js";import{_ as Pe}from"./SelectGroup.vue_vue_type_script_setup_true_lang-CwIOzTi6.js";import{_ as m}from"./index-BeOV968Y.js";import{_ as Se}from"./BoxPanelWrapper.vue_vue_type_script_setup_true_lang-CmJ-Iy6y.js";import{_ as Ce}from"./SaisieRhLayout.vue_vue_type_script_setup_true_lang-CNwSXs2g.js";import{_ as Ee}from"./FilterBadges.vue_vue_type_script_setup_true_lang-CBuiPNtr.js";import{u as Fe}from"./usePostApi-Crg8MURP.js";import{u as B}from"./useGetApi-EdzHoZm6.js";import{e as T}from"./eventBus-CGRXT3Tn.js";import"./index-BpkKmY4O.js";import"./RovingFocusGroup-BxePylpC.js";import"./DashPageHeader.vue_vue_type_script_setup_true_lang-DucYyTAx.js";import"./DashLayout.vue_vue_type_script_setup_true_lang-Ch2egXHm.js";import"./RightDashHeader.vue_vue_type_script_setup_true_lang-Bn3G870_.js";const De={class:"flex items-center gap-3 justify-between"},Ue={class:"flex flex-1 items-center gap-2"},Ve={class:"relative w-full max-w-xs"},Te={class:"grid gap-4"},Le={class:"flex flex-col gap-3.5"},Oe={class:"space-y-1.5"},Re={class:"space-y-1.5"},Ie={class:"flex items-center gap-2"},Je={class:"flex items-center gap-2"},Me={class:"flex items-center gap-2"},Be={class:"flex items-center gap-2"},Ge={class:"flex items-center gap-2"},ze={class:"font-medium"},qe={class:"mt-4 rounded-md overflow-hidden flex flex-1 bg-white"},He={class:"flex items-center gap-2"},Qe={class:"relative inline-flex items-center cursor-pointer group"},Ye=["checked","onChange","disabled"],Ke={key:0,class:"absolute right-[-24px]"},We={class:"flex items-center gap-2"},Xe={class:"flex items-center gap-2"},Ze={class:"flex items-center gap-2"},et={class:"flex items-center gap-2"},tt={class:"flex items-center gap-2"},st={key:0},kt=ge({__name:"ListePresence",setup(at){const $=R(""),N=()=>{const e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${i}`},d=_e({status:void 0,date:N()}),ae=e=>{e==="status"&&(d.status=void 0),e==="date"&&(d.date=N())},le={status:e=>({present:"Pr√©sent",absent:"Absent Non Justifi√©",justified:"Absent Justifi√©",sick:"Malade"})[e]||e,date:e=>new Date(e).toLocaleDateString("fr-FR")},{data:P,fetchData:ne}=B(w.GET_FONCTIONS),{data:S,fetchData:oe}=B(w.GET_PERSONALS),h=y(()=>{const e={};return d.date&&(e.date=d.date),d.status&&(e.status=d.status),e}),{data:C,fetchData:L,loading:re}=B(w.GET_PRESENCES);I(C,e=>{e&&(console.log("üîç Donn√©es de pr√©sences re√ßues:",e),Array.isArray(e)&&e.length>0&&(console.log("üîç Premier √©l√©ment:",e[0]),console.log("üîç Cl√©s disponibles:",Object.keys(e[0]))))},{immediate:!0}),I(S,e=>{e&&(console.log("üë• Donn√©es des personnels re√ßues:",e),Array.isArray(e)&&e.length>0&&console.log("üë• Premier personnel:",e[0]))},{immediate:!0});const ie=y(()=>{var i,c;const e=Array.isArray(S.value)?S.value:((i=S.value)==null?void 0:i.data)||[],t=Array.isArray(C.value)?C.value:((c=C.value)==null?void 0:c.data)||[];console.log("üîÑ Merge - Personnels:",e.length,"Pr√©sences:",t.length);const n=new Map;return t.forEach(u=>{n.set(Number(u.personnel_id),u)}),e.map(u=>{const x=Number(u.id),f=n.get(x),H={id:(f==null?void 0:f.id)||`temp-${x}`,personnel_id:x,personnel_name:`${u.name||u.nom||""} ${u.postnom||""} ${u.firstname||u.prenom||""}`.trim(),fonction_id:u.fonction_id,presence:f?f.presence==="1"||f.presence===1||f.presence===!0:!1,absent_justified:f?f.absent_justified==="1"||f.absent_justified===1||f.absent_justified===!0:!1,sick:f?f.sick==="1"||f.sick===1||f.sick===!0:!1};return e.length>0&&u===e[0]&&console.log("üîç Premier personnel merg√©:",H),H})}),ue=y(()=>{let e=ie.value;if($.value.trim()){const t=$.value.toLowerCase();e=e.filter(n=>{var u,x;const i=((u=n.personnel_name)==null?void 0:u.toLowerCase())||"",c=((x=n.fonction)==null?void 0:x.toLowerCase())||"";return i.includes(t)||c.includes(t)})}return e}),de=e=>e.sick?"sick":e.absent_justified?"justified":e.presence?"present":"absent",fe=e=>{const t={present:{label:"Pr√©sent",color:"bg-green-100 text-green-800 border-green-200"},absent:{label:"Absent Non Justifi√©",color:"bg-red-100 text-red-800 border-red-200"},justified:{label:"Absent Justifi√©",color:"bg-orange-100 text-orange-800 border-orange-200"},sick:{label:"Malade",color:"bg-blue-100 text-blue-800 border-blue-200"}};return t[e]||t.absent},O=y(()=>ue.value.map(e=>{const t=de(e),n=fe(t);return{...e,_status:t,_statusConfig:n}})),ce=e=>{var i;if(!e||!P.value)return"N/A";const n=(Array.isArray(P.value)?P.value:((i=P.value)==null?void 0:i.data)||[]).find(c=>c.id==e);return(n==null?void 0:n.name)||(n==null?void 0:n.title)||(n==null?void 0:n.libelle)||"N/A"},G=be(),E=y(()=>{var e;return((e=G.user)==null?void 0:e.id)||null}),F=y(()=>{var e;return((e=G.user)==null?void 0:e.school_id)||null}),{error:D,response:z,postData:q}=Fe(),p=R(null),k=R(null);I([()=>d.date,()=>d.status],async()=>{console.log("Filter params changed, fetching with params:",h.value),d.date&&(console.log("D√©but du fetch avec params:",h.value),await L(h.value),console.log("Fetch termin√©"))},{immediate:!1}),ve(async()=>{await ne(),await oe(),await L(h.value),T.on("presenceUpdated",()=>{L(h.value)})}),xe(()=>{T.off("presenceUpdated")});async function me(e,t){var i;const n={presence:e.presence,absent_justified:e.absent_justified,sick:e.sick};if(e.presence=t,e.absent_justified=!1,e.sick=!1,!E.value||!F.value){Object.assign(e,n),b({message:"Impossible d'identifier l'utilisateur ou l'√©cole.",type:"error"});return}try{p.value=e.id,console.log("üì§ Envoi de la pr√©sence - personnel_id:",e.personnel_id,"Type:",typeof e.personnel_id),console.log("üì§ Pr√©sence compl√®te:",e);const c={personnel_id:Number(e.personnel_id),presence:e.presence,school_id:Number(F.value),author_id:Number(E.value)};if(console.log("üì§ Payload envoy√©:",c),await q(w.ASSIGN_PRESENCE,c),D.value){Object.assign(e,n),b({message:D.value,type:"error"});return}const u=((i=z.value)==null?void 0:i.message)||"Pr√©sence mise √† jour.";b({message:u,type:"success"}),k.value=e.id,setTimeout(()=>{k.value=null},1e3),T.emit("presenceUpdated")}catch{Object.assign(e,n),b({message:"Une erreur inattendue s'est produite.",type:"error"})}finally{p.value=null}}async function pe(e,t){var i;const n={presence:e.presence,absent_justified:e.absent_justified,sick:e.sick};switch(t){case"present":e.presence=!0,e.absent_justified=!1,e.sick=!1;break;case"absent":e.presence=!1,e.absent_justified=!1,e.sick=!1;break;case"justified":e.presence=!1,e.absent_justified=!0,e.sick=!1;break;case"sick":e.presence=!1,e.absent_justified=!1,e.sick=!0;break}if(!E.value||!F.value){Object.assign(e,n),b({message:"Impossible d'identifier l'utilisateur ou l'√©cole.",type:"error"});return}try{p.value=e.id;const c={personnel_id:Number(e.personnel_id),presence:e.presence,school_id:Number(F.value),author_id:Number(E.value)};if(await q(w.ASSIGN_PRESENCE,c),D.value){Object.assign(e,n),b({message:D.value,type:"error"});return}const u=((i=z.value)==null?void 0:i.message)||"Statut de pr√©sence mis √† jour.";b({message:u,type:"success"}),k.value=e.id,setTimeout(()=>{k.value=null},1500),T.emit("presenceUpdated")}catch{Object.assign(e,n),b({message:"Une erreur inattendue s'est produite.",type:"error"})}finally{p.value=null}}return(e,t)=>(_(),j(Ce,{activeBread:"Presence","active-tag-name":"presence",group:"saisie"},{default:l(()=>[a(Se,null,{default:l(()=>[o("div",De,[o("div",Ue,[o("div",Ve,[a(s(te),{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=n=>$.value=n),type:"text",id:"search",name:"search",placeholder:"Rechercher un personnel...",class:"w-full max-w-xs ps-10 border border-gray-200/40 bg-white transition-all h-10 rounded-md"},null,8,["modelValue"]),t[4]||(t[4]=o("div",{class:"absolute left-3 top-1/2 transform -translate-y-1/2 text-foreground-muted/70"},[o("span",{class:"flex iconify hugeicons--search-01 text-sm"})],-1))]),a(s(Ae),null,{default:l(()=>[a(s($e),{"as-child":""},{default:l(()=>[a(s(Q),{variant:"ghost",size:"sm",class:"h-10 rounded-md border bg-white"},{default:l(()=>[...t[5]||(t[5]=[o("span",{class:"hidden sm:flex"}," Filtre",-1),o("span",{class:"iconify hugeicons--filter"},"Filtre",-1)])]),_:1})]),_:1}),a(s(Ne),{class:"w-80"},{default:l(()=>[o("div",Te,[t[12]||(t[12]=o("div",{class:"space-y-2"},[o("h4",{class:"font-medium leading-none"}," Filtrage ")],-1)),o("div",Le,[o("div",Oe,[a(s(Y),{class:"text-foreground-muted font-light",for:"date"},{default:l(()=>[...t[6]||(t[6]=[r("Date",-1)])]),_:1}),a(s(te),{id:"date",type:"date",class:"h-10 bg-white",modelValue:d.date,"onUpdate:modelValue":t[1]||(t[1]=n=>d.date=n)},null,8,["modelValue"])]),o("div",Re,[a(s(Y),{class:"text-foreground-muted font-light",for:"status"},{default:l(()=>[...t[7]||(t[7]=[r("Statut",-1)])]),_:1}),a(s(K),{modelValue:d.status,"onUpdate:modelValue":t[2]||(t[2]=n=>d.status=n)},{default:l(()=>[a(s(W),{class:"h-10 w-full"},{default:l(()=>[a(s(X),{placeholder:"S√©lectionner un statut"})]),_:1}),a(s(Z),null,{default:l(()=>[a(s(Pe),null,{default:l(()=>[a(s(g),{value:"present"},{default:l(()=>[o("div",Ie,[a(s(m),{class:"bg-green-100 text-green-800 border-green-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[8]||(t[8]=[r(" Pr√©sent ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"absent"},{default:l(()=>[o("div",Je,[a(s(m),{class:"bg-red-100 text-red-800 border-red-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[9]||(t[9]=[r(" Absent Non Justifi√© ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"justified"},{default:l(()=>[o("div",Me,[a(s(m),{class:"bg-orange-100 text-orange-800 border-orange-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[10]||(t[10]=[r(" Absent Justifi√© ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"sick"},{default:l(()=>[o("div",Be,[a(s(m),{class:"bg-blue-100 text-blue-800 border-blue-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[11]||(t[11]=[r(" Malade ",-1)])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])])])]),_:1})]),_:1}),a(Ee,{filters:d,"custom-labels":le,onRemoveFilter:ae},null,8,["filters"]),o("div",Ge,[a(s(m),{variant:"outline",class:"h-10 px-3 flex items-center gap-2 bg-white"},{default:l(()=>[t[13]||(t[13]=o("span",{class:"iconify hugeicons--calendar-03 text-sm"},null,-1)),o("span",ze,U(new Date(d.date).toLocaleDateString("fr-FR")),1)]),_:1}),d.date!==N()?(_(),j(s(Q),{key:0,variant:"outline",size:"sm",class:"h-10",onClick:t[3]||(t[3]=n=>d.date=N())},{default:l(()=>[...t[14]||(t[14]=[o("span",{class:"iconify hugeicons--calendar-check-in-02 mr-1"},null,-1),r(" Aujourd'hui ",-1)])]),_:1})):J("",!0)])]),t[15]||(t[15]=o("div",{class:"flex flex-wrap items-center gap-2.5"},null,-1))]),o("div",qe,[a(s(ke),{class:"rounded-md bg-white"},{default:l(()=>[a(s(we),null,{default:l(()=>[a(s(V),null,{default:l(()=>[a(s(A),{class:"w-[20px]"},{default:l(()=>[a(s(se),{class:"bg-white scale-70"})]),_:1}),a(s(A),null,{default:l(()=>[...t[16]||(t[16]=[r(" Nom complet ",-1)])]),_:1}),a(s(A),null,{default:l(()=>[...t[17]||(t[17]=[r(" Fonction ",-1)])]),_:1}),a(s(A),null,{default:l(()=>[...t[18]||(t[18]=[r(" Pr√©sence ",-1)])]),_:1}),a(s(A),null,{default:l(()=>[...t[19]||(t[19]=[r(" Statut ",-1)])]),_:1})]),_:1})]),_:1}),a(s(je),null,{default:l(()=>[s(re)?(_(),j(s(V),{key:0},{default:l(()=>[a(s(v),{colspan:"5",class:"text-center py-8"},{default:l(()=>[...t[20]||(t[20]=[o("span",{class:"flex justify-center items-center gap-2"},[o("span",{class:"animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-gray-400"}),r(" Chargement des pr√©sences... ")],-1)])]),_:1})]),_:1})):O.value&&O.value.length>0?(_(!0),M(he,{key:1},ye(O.value,n=>(_(),j(s(V),{key:n.id,class:ee({"bg-primary-50 transition-colors duration-500":k.value===n.id})},{default:l(()=>[a(s(v),{class:"w-[40px]"},{default:l(()=>[a(s(se),{class:"bg-white scale-70"})]),_:1}),a(s(v),null,{default:l(()=>[r(U(n.personnel_name||"N/A"),1)]),_:2},1024),a(s(v),null,{default:l(()=>[r(U(ce(n.fonction_id)),1)]),_:2},1024),a(s(v),null,{default:l(()=>[o("div",He,[o("label",Qe,[o("input",{type:"checkbox",checked:!!n.presence,onChange:i=>{var c;return me(n,(c=i.target)==null?void 0:c.checked)},class:"sr-only peer",disabled:p.value===n.id},null,40,Ye),t[22]||(t[22]=o("div",{class:"w-10 h-6 bg-gray-200 rounded-full peer-checked:bg-primary transition-colors duration-200 group-hover:ring-2 group-hover:ring-primary-300"},null,-1)),t[23]||(t[23]=o("div",{class:"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"},null,-1)),p.value===n.id?(_(),M("span",Ke,[...t[21]||(t[21]=[o("span",{class:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-primary-500"},null,-1)])])):J("",!0)])])]),_:2},1024),a(s(v),{class:"text-left max-w-xs"},{default:l(()=>[o("div",We,[a(s(K),{"model-value":n._status,"onUpdate:modelValue":i=>pe(n,i),disabled:p.value===n.id},{default:l(()=>[a(s(W),{class:"w-[200px] h-9"},{default:l(()=>[a(s(X),null,{default:l(()=>[a(s(m),{class:ee([n._statusConfig.color,"px-2 py-1 text-xs font-medium border"])},{default:l(()=>[r(U(n._statusConfig.label),1)]),_:2},1032,["class"])]),_:2},1024)]),_:2},1024),a(s(Z),null,{default:l(()=>[a(s(g),{value:"present"},{default:l(()=>[o("div",Xe,[a(s(m),{class:"bg-green-100 text-green-800 border-green-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[24]||(t[24]=[r(" Pr√©sent ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"absent"},{default:l(()=>[o("div",Ze,[a(s(m),{class:"bg-red-100 text-red-800 border-red-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[25]||(t[25]=[r(" Absent Non Justifi√© ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"justified"},{default:l(()=>[o("div",et,[a(s(m),{class:"bg-orange-100 text-orange-800 border-orange-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[26]||(t[26]=[r(" Absent Justifi√© ",-1)])]),_:1})])]),_:1}),a(s(g),{value:"sick"},{default:l(()=>[o("div",tt,[a(s(m),{class:"bg-blue-100 text-blue-800 border-blue-200 px-2 py-1 text-xs font-medium border"},{default:l(()=>[...t[27]||(t[27]=[r(" Malade ",-1)])]),_:1})])]),_:1})]),_:1})]),_:2},1032,["model-value","onUpdate:modelValue","disabled"]),p.value===n.id?(_(),M("span",st,[...t[28]||(t[28]=[o("span",{class:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-primary-500"},null,-1)])])):J("",!0)])]),_:2},1024)]),_:2},1032,["class"]))),128)):(_(),j(s(V),{key:2},{default:l(()=>[a(s(v),{colspan:"5",class:"text-center py-8 text-gray-500"},{default:l(()=>[...t[29]||(t[29]=[r(" Aucune donn√©e de pr√©sence trouv√©e pour la date s√©lectionn√©e ",-1)])]),_:1})]),_:1}))]),_:1})]),_:1})])]),_:1})]),_:1}))}});export{kt as default};
